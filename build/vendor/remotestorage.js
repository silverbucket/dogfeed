/** remotestorage.js 0.10.2, http://remotestorage.io, MIT-licensed **/
/** remotestorage.js 0.10.2, http://remotestorage.io, MIT-licensed **/
(function(e){function t(e){function o(e){if(r){var t;if(e.fulfilled)try{t=[e.fulfilled.apply(null,s)]}catch(o){return e.promise.reject(o),void 0}else t=s;t[0]&&"function"==typeof t[0].then?t[0].then(e.promise.fulfill,e.promise.reject):e.promise.fulfill.apply(null,t)}else if(e.rejected){var i;try{i=e.rejected.apply(null,s)}catch(o){return e.promise.reject(o),void 0}i&&"function"==typeof i.then?i.then(e.promise.fulfill,e.promise.reject):e.promise.fulfill(i)}else e.promise.reject.apply(null,s)}function i(e,t){return s?(console.error("WARNING: Can't resolve promise, already resolved!"),void 0):(r=e,s=Array.prototype.slice.call(t),setTimeout(function(){var e=a.length;0!==e||r||console.error("Possibly uncaught error: ",s,s[0]&&s[0].stack);for(var t=0;e>t;t++)o(a[t]);a=void 0},0),void 0)}var n;"function"==typeof e&&setTimeout(function(){try{e(n)}catch(t){n.reject(t)}},0);var r,s,a=[];return n={then:function(e,i){var n={fulfilled:"function"==typeof e?e:void 0,rejected:"function"==typeof i?i:void 0,promise:t()};return s?setTimeout(function(){o(n)},0):a.push(n),n.promise},fulfill:function(){return i(!0,arguments),this},reject:function(){return i(!1,arguments),this}}}e.promising=t})("undefined"!=typeof window?window:global),function(e){function t(e){"string"==typeof e?console.error(e):console.error(e.message,e.stack)}function o(e){var t=Array.prototype.slice.call(arguments);(403===e||401===e)&&this._emit("error",new r.Unauthorized);var o=promising();return o.fulfill.apply(o,t)}function i(e){return"dropbox"===this.backend&&e.match(/^\/public\/.*[^\/]$/)}var n={get:function(e,t){if(this.local){void 0===t&&(t=this.connected?2*this.getSyncInterval():!1);var o=function(e){return e!==!1&&"number"!=typeof e};if(o(t)){var i=promising();return i.reject("Argument 'maxAge' must be false or a number"),i}return this.local.get(e,t,this.sync.queueGetRequest.bind(this.sync))}return this.remote.get(e)},put:function(e,t,o){return i.bind(this)(e)?n._wrapBusyDone.call(this,this.remote.put(e,t,o)):this.local?this.local.put(e,t,o):n._wrapBusyDone.call(this,this.remote.put(e,t,o))},"delete":function(e){return this.local?this.local.delete(e):n._wrapBusyDone.call(this,this.remote.delete(e))},_wrapBusyDone:function(e){var t=this;return this._emit("wire-busy"),e.then(function(){var e=promising();return t._emit("wire-done",{success:!0}),e.fulfill.apply(e,arguments)},function(e){throw t._emit("wire-done",{success:!1}),e})}},r=function(){if(r.eventHandling(this,"ready","connected","disconnected","not-connected","conflict","error","features-loaded","connecting","authing","wire-busy","wire-done","sync-interval-change"),this._pending=[],this._setGPD({get:this._pendingGPD("get"),put:this._pendingGPD("put"),"delete":this._pendingGPD("delete")}),this._cleanups=[],this._pathHandlers={change:{}},this.apiKeys={},this.localStorageAvailable()){try{this.apiKeys=JSON.parse(localStorage["remotestorage:api-keys"])}catch(e){}this.setBackend(localStorage["remotestorage:backend"]||"remotestorage")}var t=this.on;this.on=function(e,o){return"ready"===e&&this.remote.connected&&this._allLoaded?setTimeout(o,0):"features-loaded"===e&&this._allLoaded&&setTimeout(o,0),t.call(this,e,o)},this._init(),this.fireInitial=function(){this.local&&setTimeout(this.local.fireInitial.bind(this.local),0)}.bind(this),this.on("ready",this.fireInitial.bind(this))};r.SyncedGetPutDelete=n,r.DiscoveryError=function(e){Error.apply(this,arguments),this.message=e},r.DiscoveryError.prototype=Object.create(Error.prototype),r.Unauthorized=function(){Error.apply(this,arguments)},r.Unauthorized.prototype=Object.create(Error.prototype),r.log=function(){r.config.logging&&console.log.apply(console,arguments)},r.config={logging:!1,changeEvents:{local:!0,window:!1,remote:!0,conflict:!0},discoveryTimeout:1e4},r.prototype={connect:function(e){if(this.setBackend("remotestorage"),0>e.indexOf("@"))return this._emit("error",new r.DiscoveryError("User address doesn't contain an @.")),void 0;this.remote.configure(e),this._emit("connecting");var t=setTimeout(function(){this._emit("error",new r.DiscoveryError("No storage information found at that user address."))}.bind(this),r.config.discoveryTimeout);r.Discover(e,function(o,i,n){return clearTimeout(t),o?(this._emit("authing"),this.remote.configure(e,o,i),this.remote.connected||(n?this.authorize(n):this.impliedauth()),void 0):(this._emit("error",new r.DiscoveryError("Failed to contact storage server.")),void 0)}.bind(this))},disconnect:function(){this.remote&&this.remote.configure(null,null,null,null),this._setGPD({get:this._pendingGPD("get"),put:this._pendingGPD("put"),"delete":this._pendingGPD("delete")});var e=this._cleanups.length,t=0,o=function(){t++,t>=e&&(this._init(),r.log("Done cleaning up, emitting disconnected and disconnect events"),this._emit("disconnected"))}.bind(this);e>0?this._cleanups.forEach(function(e){var t=e(this);"object"==typeof e&&"function"==typeof e.then?t.then(o):o()}.bind(this)):o()},setBackend:function(e){this.backend=e,this.localStorageAvailable()&&(e?localStorage["remotestorage:backend"]=e:delete localStorage["remotestorage:backend"])},onChange:function(e,t){this._pathHandlers.change[e]||(this._pathHandlers.change[e]=[]),this._pathHandlers.change[e].push(t)},enableLog:function(){r.config.logging=!0},disableLog:function(){r.config.logging=!1},log:function(){r.log.apply(r,arguments)},setApiKeys:function(e,t){t?this.apiKeys[e]=t:delete this.apiKeys[e],this.localStorageAvailable()&&(localStorage["remotestorage:api-keys"]=JSON.stringify(this.apiKeys))},_init:function(){function e(){try{i||(o._emit("ready"),i=!0)}catch(e){console.error("'ready' failed: ",e,e.stack),o._emit("error",e)}}var o=this,i=!1;this._loadFeatures(function(i){this.log("[RemoteStorage] All features loaded"),this.local=i.local&&new i.local,this.local&&this.remote?(this._setGPD(n,this),this._bindChange(this.local)):this.remote&&this._setGPD(this.remote,this.remote),this.remote&&(this.remote.on("connected",function(){e(),o._emit("connected")}),this.remote.on("not-connected",function(){e(),o._emit("not-connected")}),this.remote.connected&&(e(),o._emit("connected"))),this._collectCleanupFunctions();try{this._allLoaded=!0,this._emit("features-loaded")}catch(r){t(r),this._emit("error",r)}this._processPending()}.bind(this))},_collectCleanupFunctions:function(){for(var e=0;this.features.length>e;e++){var t=this.features[e].cleanup;"function"==typeof t&&this._cleanups.push(t)}},_loadFeatures:function(e){function t(){l++,l===a.length&&setTimeout(function(){c.caching=!!r.Caching,c.sync=!!r.Sync,["IndexedDB","LocalStorage","InMemoryStorage"].some(function(e){return c.some(function(t){return t.name===e})?(c.local=r[e],!0):void 0}),u.features=c,e(c)},0)}function o(e){u.log("[RemoteStorage] [FEATURE "+e+"] initialized."),c.push({name:e,init:r[e]._rs_init,supported:!0,cleanup:r[e]._rs_cleanup}),t()}function i(e,o){u.log("[RemoteStorage] [FEATURE "+e+"] initialization failed ( "+o+")"),t()}function n(e,o){u.log("[RemoteStorage] [FEATURE "+e+"]"+o?"":" not supported"),o||t()}function s(e){var t;try{t=r[e]._rs_init(u)}catch(n){return i(e,n),void 0}"object"==typeof t&&"function"==typeof t.then?t.then(function(){o(e)},function(t){i(e,t)}):o(e)}var a=["WireClient","I18n","Dropbox","GoogleDrive","Access","Caching","Discover","Authorize","Widget","IndexedDB","LocalStorage","InMemoryStorage","Sync","BaseClient","Env"],c=[],l=0,u=this;a.forEach(function(e){u.log("[RemoteStorage] [FEATURE "+e+"] initializing...");var t,o=r[e];o?(t=!o._rs_supported||o._rs_supported(),"object"==typeof t?t.then(function(){n(e,!0),s(e)},function(){n(e,!1)}):"boolean"==typeof t&&(n(e,t),t&&s(e))):n(e,!1)})},localStorageAvailable:function(){try{return!!e.localStorage}catch(t){return!1}},_setGPD:function(e,t){function i(e){return function(){return e.apply(t,arguments).then(o.bind(this))}}this.get=i(e.get),this.put=i(e.put),this.delete=i(e.delete)},_pendingGPD:function(e){return function(){var t=promising();return this._pending.push({method:e,args:Array.prototype.slice.call(arguments),promise:t}),t}.bind(this)},_processPending:function(){this._pending.forEach(function(e){try{this[e.method].apply(this,e.args).then(e.promise.fulfill,e.promise.reject)}catch(t){e.promise.reject(t)}}.bind(this)),this._pending=[]},_bindChange:function(e){e.on("change",this._dispatchEvent.bind(this,"change"))},_dispatchEvent:function(e,t){for(var o in this._pathHandlers[e]){var i=o.length,n=this;t.path.substr(0,i)===o&&this._pathHandlers[e][o].forEach(function(e){var i={};for(var r in t)i[r]=t[r];i.relativePath=t.path.replace(RegExp("^"+o),"");try{e(i)}catch(s){console.error("'change' handler failed: ",s,s.stack),n._emit("error",s)}})}}},Object.defineProperty(r.prototype,"connected",{get:function(){return this.remote.connected}}),e.RemoteStorage=r}("undefined"!=typeof window?window:global),function(){function e(t,o){var i,n,r;if("object"==typeof t&&!Array.isArray(t)&&null!==t)for(i in t)"object"==typeof t[i]&&null!==t[i]&&("[object ArrayBuffer]"==""+t[i]?(o[i]=new ArrayBuffer(t[i].byteLength),n=new Int8Array(t[i]),r=new Int8Array(o[i]),r.set(n)):e(t[i],o[i]))}RemoteStorage.util={getEventEmitter:function(){var e={},t=Array.prototype.slice.call(arguments);return t.unshift(e),RemoteStorage.eventHandling.apply(RemoteStorage,t),e.emit=e._emit,e},extend:function(e){var t=Array.prototype.slice.call(arguments,1);return t.forEach(function(t){for(var o in t)e[o]=t[o]}),e},asyncEach:function(e,t){return this.asyncMap(e,t).then(function(){return e})},asyncMap:function(e,t){function o(){r++,r===n&&i.fulfill(s,a)}var i=promising(),n=e.length,r=0,s=[],a=[];return e.forEach(function(e,i){var n;try{n=t(e)}catch(r){o(),a[i]=r}"object"==typeof n&&"function"==typeof n.then?n.then(function(e){s[i]=e,o()},function(e){a[i]=e,o()}):(o(),s[i]=n)}),i},containingFolder:function(e){if(""===e)return"/";if(!e)throw"Path not given!";return e.replace(/\/+/g,"/").replace(/[^\/]+\/?$/,"")},isFolder:function(e){return"/"===e.substr(-1)},isDocument:function(e){return"/"!==e.substr(-1)},baseName:function(e){var t=e.split("/");return this.isFolder(e)?t[t.length-2]+"/":t[t.length-1]},bindAll:function(e){for(var t in this)"function"==typeof e[t]&&(e[t]=e[t].bind(e))},equal:function(e,t){return JSON.stringify(e)===JSON.stringify(t)},equalObj:function(e,t){var o;for(o in t)if(e[o]===void 0)return!1;for(o in t)if(t[o])switch(typeof t[o]){case"object":if(!t[o].equals(e[o]))return!1;break;case"function":if(e[o]===void 0||"equals"!==o&&""+t[o]!=""+e[o])return!1;break;default:if(t[o]!==e[o])return!1}else if(e[o])return!1;for(o in e)if(t[o]===void 0)return!1;return!0},deepClone:function(t){var o;return void 0===t?void 0:(o=JSON.parse(JSON.stringify(t)),e(t,o),o)},pathsFromRoot:function(e){for(var t=[e],o=e.replace(/\/$/,"").split("/");o.length>1;)o.pop(),t.push(o.join("/")+"/");return t}},RemoteStorage.prototype.util||Object.defineProperty(RemoteStorage.prototype,"util",{get:function(){return console.log("DEPRECATION WARNING: remoteStorage.util was moved to RemoteStorage.util"),RemoteStorage.util}})}(),function(){var e={addEventListener:function(e,t){if("string"!=typeof e)throw Error("Argument eventName should be a string");if("function"!=typeof t)throw Error("Argument handler should be a function");RemoteStorage.log("[Eventhandling] Adding event listener",e,t),this._validateEvent(e),this._handlers[e].push(t)},removeEventListener:function(e,t){this._validateEvent(e);for(var o=this._handlers[e].length,i=0;o>i;i++)if(this._handlers[e][i]===t)return this._handlers[e].splice(i,1),void 0},_emit:function(e){this._validateEvent(e);var t=Array.prototype.slice.call(arguments,1);this._handlers[e].forEach(function(e){e.apply(this,t)})},_validateEvent:function(e){if(!(e in this._handlers))throw Error("Unknown event: "+e)},_delegateEvent:function(e,t){t.on(e,function(t){this._emit(e,t)}.bind(this))},_addEvent:function(e){this._handlers[e]=[]}};e.on=e.addEventListener,RemoteStorage.eventHandling=function(t){var o=Array.prototype.slice.call(arguments,1);for(var i in e)t[i]=e[i];t._handlers={},o.forEach(function(e){t._addEvent(e)})}}("undefined"!=typeof window?window:global),function(e){function t(e){return"string"!=typeof e?e:"*"===e?"*":'"'+e+'"'}function o(e){return"string"!=typeof e?e:e.replace(/^["']|["']$/g,"")}function i(e,t,o){var i=new Blob([e],{type:t}),n=new FileReader;n.addEventListener("loadend",function(){o(n.result)}),n.readAsArrayBuffer(i)}function n(e,t,o){if("undefined"==typeof Blob){var i=new Buffer(new Uint8Array(e));o(i.toString(t))}else{var n=new Blob([e]),r=new FileReader;r.addEventListener("loadend",function(e){o(e.target.result)}),r.readAsText(n,t)}}function r(e){var t,o="UTF-8";return e&&(t=e.match(/charset=(.+)$/),t&&(o=t[1])),o}function s(e){return e.replace(/\/+/g,"/").split("/").map(encodeURIComponent).join("/")}function a(e){return"http://remotestorage.io/spec/folder-description"===e["@context"]&&"object"==typeof e.items}function c(e){return[201,204,304].indexOf(e)>=0}function l(e){return[401,403,404,412].indexOf(e)>=0}var u,d,h=RemoteStorage,g="remotestorage:wireclient",m=1,f=2,p=3,y=4,v=5,M={"draft-dejong-remotestorage-00":f,"draft-dejong-remotestorage-01":p,"draft-dejong-remotestorage-02":y,"https://www.w3.org/community/rww/wiki/read-write-web-00#simple":m};if("function"==typeof ArrayBufferView)d=function(e){return e&&e instanceof ArrayBufferView};else{var b=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];d=function(e){for(var t=0;8>t;t++)if(e instanceof b[t])return!0;return!1}}var S,w=RemoteStorage.util.isFolder;h.WireClient=function(e){if(this.connected=!1,h.eventHandling(this,"change","connected","wire-busy","wire-done","not-connected"),S=function(e){e instanceof RemoteStorage.Unauthorized&&this.configure(void 0,void 0,void 0,null)}.bind(this),e.on("error",S),u){var t;try{t=JSON.parse(localStorage[g])}catch(o){}t&&setTimeout(function(){this.configure(t.userAddress,t.href,t.storageApi,t.token)}.bind(this),0)}this._revisionCache={},this.connected&&setTimeout(this._emit.bind(this),0,"connected")},h.WireClient.REQUEST_TIMEOUT=3e4,h.WireClient.prototype={_request:function(e,t,i,s,a,u,d){if(("PUT"===e||"DELETE"===e)&&"/"===t[t.length-1])throw"Don't "+e+" on directories!";var g,m=promising(),f=this;return i!==RemoteStorage.Authorize.IMPLIED_FAKE_TOKEN&&(s.Authorization="Bearer "+i),this._emit("wire-busy",{method:e,isFolder:w(t)}),h.WireClient.request(e,t,{body:a,headers:s,responseType:"arraybuffer"},function(i,s){if(i)f._emit("wire-done",{method:e,isFolder:w(t),success:!1}),m.reject(i);else if(f._emit("wire-done",{method:e,isFolder:w(t),success:!0}),f.online=!0,l(s.status))RemoteStorage.log("[WireClient] Error response status",s.status),g=u?o(s.getResponseHeader("ETag")):void 0,m.fulfill(s.status,void 0,void 0,g);else if(c(s.status)||200===s.status&&"GET"!==e)g=o(s.getResponseHeader("ETag")),RemoteStorage.log("[WireClient] Successful request",g),m.fulfill(s.status,void 0,void 0,g);else{var a=s.getResponseHeader("Content-Type");g=u?o(s.getResponseHeader("ETag")):200===s.status?d:void 0;var h=r(a);a&&"binary"!==h?n(s.response,h,function(e){RemoteStorage.log("[WireClient] Successful request",g),m.fulfill(s.status,e,a,g)}):(RemoteStorage.log("[WireClient] Successful request with unknown or binary mime-type",g),m.fulfill(s.status,s.response,a,g))}}),m},configure:function(e,t,o,i){e!==void 0&&(this.userAddress=e),t!==void 0&&(this.href=t),o!==void 0&&(this.storageApi=o),i!==void 0&&(this.token=i),this.storageApi!==void 0&&(this._storageApi=M[this.storageApi]||v,this.supportsRevs=this._storageApi>=f),this.href&&this.token?(this.connected=!0,this.online=!0,this._emit("connected")):this.connected=!1,u&&(localStorage[g]=JSON.stringify({userAddress:this.userAddress,href:this.href,token:this.token,storageApi:this.storageApi})),h.WireClient.configureHooks.forEach(function(e){e.call(this)}.bind(this))},stopWaitingForToken:function(){this.connected||this._emit("not-connected")},get:function(e,o){if(!this.connected)throw Error("not connected (path: "+e+")");o||(o={});var i={};this.supportsRevs?o.ifNoneMatch&&(i["If-None-Match"]=t(o.ifNoneMatch)):o.ifNoneMatch&&this._revisionCache[e];var n=this._request("GET",this.href+s(e),this.token,i,void 0,this.supportsRevs,this._revisionCache[e]);return w(e)?n.then(function(t,o,i,n){var r={};if(o!==void 0)try{o=JSON.parse(o)}catch(c){throw"Folder description at "+this.href+s(e)+" is not JSON"}if(200===t&&"object"==typeof o){if(0===Object.keys(o).length)t=404;else if(a(o)){for(var l in o.items)this._revisionCache[e+l]=o.items[l].ETag;r=o.items}else Object.keys(o).forEach(function(t){this._revisionCache[e+t]=o[t],r[t]={ETag:o[t]}}.bind(this));return promising().fulfill(t,r,i,n)}return promising().fulfill(t,o,i,n)}.bind(this)):n},put:function(e,o,i,n){if(!this.connected)throw Error("not connected (path: "+e+")");n||(n={}),!i.match(/charset=/)&&(o instanceof ArrayBuffer||d(o))&&(i+="; charset=binary");var r={"Content-Type":i};return this.supportsRevs&&(n.ifMatch&&(r["If-Match"]=t(n.ifMatch)),n.ifNoneMatch&&(r["If-None-Match"]=t(n.ifNoneMatch))),this._request("PUT",this.href+s(e),this.token,r,o,this.supportsRevs)},"delete":function(e,o){if(!this.connected)throw Error("not connected (path: "+e+")");o||(o={});var i={};return this.supportsRevs&&o.ifMatch&&(i["If-Match"]=t(o.ifMatch)),this._request("DELETE",this.href+s(e),this.token,i,void 0,this.supportsRevs)}},h.WireClient.cleanPath=s,h.WireClient.isArrayBufferView=d,h.WireClient.readBinaryData=i,h.WireClient.request=function(e,t,o,i){RemoteStorage.log("[WireClient]",e,t),i=i.bind(this);var n=!1,r=setTimeout(function(){n=!0,i("timeout")},h.WireClient.REQUEST_TIMEOUT),s=new XMLHttpRequest;if(s.open(e,t,!0),o.responseType&&(s.responseType=o.responseType),o.headers)for(var a in o.headers)s.setRequestHeader(a,o.headers[a]);s.onload=function(){n||(clearTimeout(r),i(null,s))},s.onerror=function(e){n||(clearTimeout(r),i(e))};var c=o.body;"object"==typeof c&&(d(c)||c instanceof ArrayBuffer&&(c=new Uint8Array(c))),s.send(c)},Object.defineProperty(RemoteStorage.WireClient.prototype,"storageType",{get:function(){if(this.storageApi){var e=this.storageApi.match(/draft-dejong-(remotestorage-\d\d)/);return e?e[1]:"2012.04"}}}),h.WireClient.configureHooks=[],h.WireClient._rs_init=function(e){u=e.localStorageAvailable(),e.remote=new h.WireClient(e),this.online=!0},h.WireClient._rs_supported=function(){return!!e.XMLHttpRequest},h.WireClient._rs_cleanup=function(e){u&&delete localStorage[g],e.removeEventListener("error",S)}}("undefined"!=typeof window?window:global),function(e){var t,o,i="remotestorage:discover",n={};RemoteStorage.Discover=function(e,t){function r(){var s=new XMLHttpRequest,a=l.shift();return a?(RemoteStorage.log("[Discover] Trying URL",a),s.open("GET",a,!0),s.onabort=s.onerror=function(){console.error("webfinger error",arguments,"(",a,")"),r()},s.onload=function(){if(200!==s.status)return r();var a;try{a=JSON.parse(s.responseText)}catch(c){return RemoteStorage.log("[Discover] Failed to parse profile ",s.responseText,c),r(),void 0}if(!a.links)return RemoteStorage.log("[Discover] Profile has no links section ",JSON.stringify(a)),r(),void 0;var l;if(a.links.forEach(function(e){"remotestorage"===e.rel?l=e:"remoteStorage"!==e.rel||l||(l=e)}),RemoteStorage.log("[Discover] Got profile",a,"and link",l),l){var u=l.properties["http://tools.ietf.org/html/rfc6749#section-4.2"]||l.properties["auth-endpoint"],d=l.properties["http://remotestorage.io/spec/version"]||l.type;n[e]={href:l.href,type:d,authURL:u},o&&(localStorage[i]=JSON.stringify({cache:n})),t(l.href,d,u)}else r()},s.send(),void 0):t()}if(e in n){var s=n[e];return t(s.href,s.type,s.authURL),void 0}var a=e.split("@")[1],c="?resource="+encodeURIComponent("acct:"+e),l=["https://"+a+"/.well-known/webfinger"+c,"http://"+a+"/.well-known/webfinger"+c];r()},RemoteStorage.Discover._rs_init=function(e){if(o=e.localStorageAvailable()){var t;try{t=JSON.parse(localStorage[i])}catch(r){}t&&(n=t.cache)}},RemoteStorage.Discover._rs_supported=function(){return t=!!e.XMLHttpRequest},RemoteStorage.Discover._rs_cleanup=function(){o&&delete localStorage[i]}}("undefined"!=typeof window?window:global),function(e){function t(){var e,t=RemoteStorage.Authorize.getLocation(),o=t.href.indexOf("#");if(-1!==o&&(e=t.href.substring(o+1),-1!==e.indexOf("=")))return e.split("&").reduce(function(e,t){var o=t.split("=");return e[decodeURIComponent(o[0])]=decodeURIComponent(o[1]),e},{})}RemoteStorage.ImpliedAuth=function(e,t){RemoteStorage.log("ImpliedAuth proceeding due to absent authURL; storageApi = "+e+" redirectUri = "+t),remoteStorage.remote.configure(void 0,void 0,void 0,RemoteStorage.Authorize.IMPLIED_FAKE_TOKEN),document.location=t},RemoteStorage.Authorize=function(e,t,o,i){RemoteStorage.log("[Authorize] authURL = ",e,"scope = ",t,"redirectUri = ",o,"clientId = ",i);var n=e,r=o.indexOf("#");n+=e.indexOf("?")>0?"&":"?",n+="redirect_uri="+encodeURIComponent(o.replace(/#.*$/,"")),n+="&scope="+encodeURIComponent(t),n+="&client_id="+encodeURIComponent(i),-1!==r&&(n+="&state="+encodeURIComponent(o.substring(r+1))),n+="&response_type=token",RemoteStorage.Authorize.setLocation(n)},RemoteStorage.Authorize.IMPLIED_FAKE_TOKEN=!1,RemoteStorage.prototype.authorize=function(e){this.access.setStorageType(this.remote.storageType);var t=this.access.scopeParameter,o=RemoteStorage.Authorize.getLocation()+"",i=o.match(/^(https?:\/\/[^\/]+)/)[0];RemoteStorage.Authorize(e,t,o,i)},RemoteStorage.Authorize.getLocation=function(){return e.document.location},RemoteStorage.Authorize.setLocation=function(t){if("string"==typeof t)e.document.location.href=t;else{if("object"!=typeof t)throw"Invalid location "+t;e.document.location=t}},RemoteStorage.prototype.impliedauth=function(){RemoteStorage.ImpliedAuth(this.remote.storageApi,document.location+"")},RemoteStorage.Authorize._rs_supported=function(){return"undefined"!=typeof document};var o;RemoteStorage.Authorize._rs_init=function(e){o=function(){var t=!1;if(n){if(n.error)throw"Authorization server errored: "+n.error;n.access_token&&(e.remote.configure(void 0,void 0,void 0,n.access_token),t=!0),n.remotestorage&&(e.connect(n.remotestorage),t=!0),n.state&&RemoteStorage.Authorize.setLocation("#"+n.state)}t||e.remote.stopWaitingForToken()};var i,n=t();n&&(i=RemoteStorage.Authorize.getLocation(),i.hash=""),e.on("features-loaded",o)},RemoteStorage.Authorize._rs_cleanup=function(e){e.removeEventListener("features-loaded",o)}}("undefined"!=typeof window?window:global),function(){RemoteStorage.Access=function(){this.reset()},RemoteStorage.Access.prototype={claim:function(e,t){if("string"!=typeof e||-1!==e.indexOf("/")||0===e.length)throw Error("Scope should be a non-empty string without forward slashes");if(!t.match(/^rw?$/))throw Error("Mode should be either 'r' or 'rw'");this._adjustRootPaths(e),this.scopeModeMap[e]=t},get:function(e){return this.scopeModeMap[e]},remove:function(e){var t,o={};for(t in this.scopeModeMap)o[t]=this.scopeModeMap[t];this.reset(),delete o[e];for(t in o)this.set(t,o[t])},checkPermission:function(e,t){var o=this.get(e);return o&&("r"===t||"rw"===o)},checkPathPermission:function(e,t){return this.checkPermission("*",t)?!0:!!this.checkPermission(this._getModuleName(e),t)},reset:function(){this.rootPaths=[],this.scopeModeMap={}},_getModuleName:function(e){if("/"!==e[0])throw Error("Path should start with a slash");var t=e.replace(/^\/public/,"").match(/^\/([^\/]*)\//);return t?t[1]:"*"},_adjustRootPaths:function(e){"*"in this.scopeModeMap||"*"===e?this.rootPaths=["/"]:e in this.scopeModeMap||(this.rootPaths.push("/"+e+"/"),this.rootPaths.push("/public/"+e+"/"))},_scopeNameForParameter:function(e){if("*"===e.name&&this.storageType){if("2012.04"===this.storageType)return"";if(this.storageType.match(/remotestorage-0[01]/))return"root"}return e.name},setStorageType:function(e){this.storageType=e}},Object.defineProperty(RemoteStorage.Access.prototype,"scopes",{get:function(){return Object.keys(this.scopeModeMap).map(function(e){return{name:e,mode:this.scopeModeMap[e]}}.bind(this))}}),Object.defineProperty(RemoteStorage.Access.prototype,"scopeParameter",{get:function(){return this.scopes.map(function(e){return this._scopeNameForParameter(e)+":"+e.mode}.bind(this)).join(" ")}}),Object.defineProperty(RemoteStorage.prototype,"access",{get:function(){var e=new RemoteStorage.Access;return Object.defineProperty(this,"access",{value:e}),e},configurable:!0}),RemoteStorage.Access._rs_init=function(){}}("undefined"!=typeof window?window:global),function(e){var t=e,o={},i=!1;RemoteStorage.Env=function(){return o},RemoteStorage.Env.isBrowser=function(){return"browser"===t},RemoteStorage.Env.isNode=function(){return"node"===t},RemoteStorage.Env.goBackground=function(){i=!0,RemoteStorage.Env._emit("background")},RemoteStorage.Env.goForeground=function(){i=!1,RemoteStorage.Env._emit("foreground")},RemoteStorage.Env._rs_init=function(){function e(){document[o.hiddenProperty]?RemoteStorage.Env.goBackground():RemoteStorage.Env.goForeground()}RemoteStorage.eventHandling(RemoteStorage.Env,"background","foreground"),"browser"===t&&(document.hidden!==void 0?(o.hiddenProperty="hidden",o.visibilityChangeEvent="visibilitychange"):document.mozHidden!==void 0?(o.hiddenProperty="mozHidden",o.visibilityChangeEvent="mozvisibilitychange"):document.msHidden!==void 0?(o.hiddenProperty="msHidden",o.visibilityChangeEvent="msvisibilitychange"):document.webkitHidden!==void 0&&(o.hiddenProperty="webkitHidden",o.visibilityChangeEvent="webkitvisibilitychange"),document.addEventListener(o.visibilityChangeEvent,e,!1),e())},RemoteStorage.Env._rs_cleanup=function(){}}("undefined"!=typeof window?"browser":"node"),function(){"use strict";var e={view_info:'This app allows you to use your own storage. <a href="http://remotestorage.io/" target="_blank">Learn more!</a>',view_connect:"<strong>Connect</strong> remote storage",view_connecting:"Connecting <strong>%s</strong>",view_offline:"Offline",view_error_occured:"Sorry! An error occured.",view_invalid_key:"Wrong key!",view_confirm_reset:"Are you sure you want to reset everything? This will clear your local data and reload the page.",view_get_me_out:"Get me out of here!",view_error_plz_report:'If this problem persists, please <a href="http://remotestorage.io/community/" target="_blank">let us know</a>!',view_unauthorized:"Unauthorized! Click here to reconnect."};RemoteStorage.I18n={translate:function(){var t=arguments[0],o=Array.prototype.splice.call(arguments,1);if("string"!=typeof e[t])throw"Unknown translation string: "+t;return t=e[t],t.replace(/%s/g,function(){return o.shift()})},getDictionary:function(){return e},setDictionary:function(t){e=t}}}(),RemoteStorage.Assets={cipherIcon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTQiIHdpZHRoPSIyNS4xNzciIHZlcnNpb249IjEuMSIgeG1sbnM6Y2M9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL25zIyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KIDxwYXRoIGQ9Im0yNS4xNzcgNS41MzIzYy0wLjA1NjQtMC4xMTI5MS0wLjA1NjQtMC4yMjU4MS0wLjE2OTM2LTAuMzM4NzEtMC4xMTI5LTAuMTEyOS0wLjI4MjI1LTAuMTY5MzYtMC4zOTUxNi0wLjE2OTM2aC0xMS40MDNjLTAuNzMzLTIuODc5LTMuMzg2NC01LjAyNDItNi40OTEzLTUuMDI0Mi0zLjY2OTMgMC02LjcxNzcgMy4wNDg0LTYuNzE3NyA2LjcxNzcgMCAzLjcyNjMgMy4wNDg0IDYuNzE3MyA2LjcxNzcgNi43MTczIDMuMzMwNyAwIDYuMDQwMy0yLjQyNzQgNi42MDQ4LTUuNTg4N2gyLjU0MDN2My42Njk0YzAgMC4yODIyNiAwLjI4MjI2IDAuNTA4MDYgMC41NjQ1MiAwLjUwODA2aDEuNzVjMC4yODIyNiAwIDAuNTY0NTItMC4yMjU4IDAuNTY0NTItMC41MDgwNnYtMy42Njk0aDEuNDY3N3Y1LjY0NTJjMCAwLjI4MjI1IDAuMjI1OCAwLjUwODA2IDAuNTA4MDYgMC41MDgwNmgxLjgwNjRjMC4yODIyNiAwIDAuNTA4MDctMC4yMjU4MSAwLjU2NDUyLTAuNTA4MDZ2LTUuNjQ1MmgxLjUyNDJjMC4xMTI5MSAwIDAuMjgyMjYgMCAwLjM5NTE2LTAuMTEyOSAwLjExMjkxLTAuMTEyOSAwLjE2OTM2LTAuMjgyMjYgMC4xNjkzNi0wLjM5NTE2di0xLjgwNjR6bS0xOC40NTkgNS4wODA3Yy0yLjA4ODcgMC0zLjgzODctMS42OTM2LTMuODM4Ny0zLjgzODcgMC0yLjE0NTIgMS43NS0zLjgzODcgMy44Mzg3LTMuODM4NyAyLjE0NTIgMCAzLjgzODcgMS42OTM2IDMuODM4NyAzLjgzODcgMCAyLjE0NTItMS42OTM2IDMuODM4Ny0zLjgzODcgMy44Mzg3eiIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4K",connectIcon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTYiIHdpZHRoPSIxNiIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iPgogPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCAtMTAzNi40KSI+CiAgPHBhdGggZD0ibTEgMTA0Ny40di02aDd2LTRsNyA3LTcgN3YtNHoiIGZpbGw9IiNmZmYiLz4KIDwvZz4KPC9zdmc+Cg==",disconnectIcon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTYiIHdpZHRoPSIxNiIgdmVyc2lvbj0iMS4wIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KIDxwYXRoIHN0eWxlPSJibG9jay1wcm9ncmVzc2lvbjp0Yjt0ZXh0LWluZGVudDowO2NvbG9yOiMwMDAwMDA7dGV4dC10cmFuc2Zvcm06bm9uZSIgZD0ibTguMDAwMSAwYy0wLjQ3MTQgMC0wLjk2MTAzIDAuNTQxOS0wLjk1IDF2NmMtMC4wMDc0NyAwLjUyODMxIDAuNDIxNjMgMSAwLjk1IDFzMC45NTc0Ny0wLjQ3MTY5IDAuOTUtMXYtNmMwLjAxNDYyMi0wLjYwNTEtMC40Nzg2LTEtMC45NS0xem0tMy4zNDM4IDIuNWMtMC4wODcxODYgMC4wMTkyOTQtMC4xNzE2MyAwLjA1MDk1OS0wLjI1IDAuMDkzNzUtMi45OTk1IDEuNTcxNS0zLjkxODQgNC43OTc5LTMuMTI1IDcuNDY4OCAwLjc5MzQgMi42NyAzLjI3OTkgNC45MzcgNi42ODc1IDQuOTM3IDMuMzU5MiAwIDUuODc3Mi0yLjE0OSA2LjcxOTItNC43ODEgMC44NDEtMi42MzIxLTAuMDU4LTUuODIzNC0zLjEyNS03LjU5NC0wLjQzNC0wLjI1MzYtMS4wNTktMC4wODk5LTEuMzEzIDAuMzQzNy0wLjI1MzYgMC40MzM2LTAuMDkgMS4wNTg5IDAuMzQ0IDEuMzEyNSAyLjM5MDggMS4zNzk4IDIuODgyNSAzLjQ5NDQgMi4yODEyIDUuMzc1LTAuNjAxMiAxLjg4MDYtMi4zNDQgMy40Mzc1LTQuOTA2MiAzLjQzNzUtMi41NzU5IDAtNC4yOTc2LTEuNjUwMi00Ljg3NS0zLjU5MzgtMC41Nzc2LTEuOTQzNS0wLjA0Ny00LjA0OCAyLjE4NzMtNS4yMTg3IDAuMzc4Ny0wLjIwNjMgMC41NzkxLTAuNjkyNSAwLjQ1NTgtMS4xMDU3LTAuMTIzMi0wLjQxMzMtMC41NTcyLTAuNzEwMy0wLjk4Ny0wLjY3NTUtMC4wMzEzLTAuMDAxNS0wLjA2MjYtMC4wMDE1LTAuMDkzOCAweiIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4K",dropbox:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QgPEBAhEOpfuQAABhZJREFUWMPVl31snVUdxz+/5/2577e3b7QbHaOD0nXshW4ZZkpGQmJYZkJUDAaZzCBGAxGd+pdZQsJIjCaKgFu09GWybIggm8yhMCsY92rcOkPHunbdtKOUbX36svX23uc+xz+eDsrWlztiNJzk5D7JPS+fc8739/2dA5+EsqJtyK18ZlCKbX9Lk6fd1uo5xbTVZmtwa4v35Np5Mry4TLYXCzAnyhsry2SwrmnokdnaTruq6i3e0lXl0tqQlkURCxwdDp9Th5p3+p9iS8afqk/VZq9kaZoDN8apdU3B1KFnmLde7AkezH0n3V0UQOJpz2hIsqEhLU+WOeAagmtCxISYBe1nVf4vfWrByYdSpyf3W9ziLapy6JgbAduAiBn2S1rCQBYODAQP7H01/zxby4JpAW5s8mproxypiRKNGIJrQNT8EMA1wTGEU8MBP/q7umPw0dSbAA3N3n3zI2yLG2oScPgbNYWICY4Be86o/le6g0W576bPXQWwcqvXdJ2t1idMsA1hJoCoCRfGYdOhwsa4TUWFrr7pGmDrzAiQCHfD//Xxwk/33Z/6HoA0tnhLXZ3XMoYqsy4PYs4M4Ohg6pB2ddqO+vR6BWL27AARXbBNiBjwh9Oqs+O8ukcT4eaopjLqGsJSCdSX29SX23x/lctXlzgE1zBAANxWIQuGxlWNACxr8WozJp0lljKsGXbA0qGu1GRBxsTUQRAGLgboIuQVvHI8S+f7eeK2TLsDSQd296rhPaeDm09+PdX/gQYqN3uZ+jh7ro+oRusKDdgmVEY1GqstSiOhdegCmoQAIoImIWTPYIHdXVlyBYhaVwLA70+rPz7fllvLi2W5KcPw9q3eS/VJ7kmYgm1A3BIWV5osq7IIlMLUQJOrAXQBXQtr1BR2d2XpOu8TtULR+gq2nQh+vv8rqUdnNaKGZm/9qnJpmp/U+fxCB5lYsaGFdTYAY9L3jmNj9F9S7OgKVh9/KNVelBVf8untv8TYSS8gbsrHyh8C2LqQtGE0z9CJYfVuUblgRZv3WGOJvJG0cF8/lWPNdo+O93xsHYoVuqkL/xzIs/HPHt2DPg0Zko+v0I8vbfHun9aKE5sH9YaobJsf5V4mRLXv33kSlmAYwspqgw23R7A1EJlahKYOSsHTB0cZHQ9IOBA3NSrjGo4hWAY82xH8rH1b/jF2laoPAOb80jPqYtKTMdRcTQNd+xAgbgmuJbiGELfh3lsc7q41KQSTABBcC1qPjLH/XzniNqScsP1kgMsm9nJ34e2mNcmFAMby1qFPZyz1WlxXrprhuEUgUPDbd8Y59n6edbe61KZ1TF14vSfPLw5dYjhXIOMIM6lGAV+u0+tv+ttI/2+6/LsMQVXpUFCAqJkS9MT5anB2NGDjWxf5Yp3DvjN5th/LUhETolaRTqigxMGIWVKtHVyX2tGTJd2X5agUIfi8CmvUFOKGT++gT8wqLlKUgnwATxwq7P32m35Z+32pPQZA54MpH1iSb/XWZmx2VthTD1AATCBlCZ+dpwNg6EJjlUH3hQIKRaCujhZFaOPtfUH+8HvBnQceSP11yjA8vC616+A5FevL8jt/YiCR0HiQcAUVrnDHHO0jHTUNllXrpC0NRXiefjAxM4rhHLzQpZqf+eFFd/LkM17JGlu9p+xC8IgPhGlaqE1rNJZrxOzQok0dnjviY+nhbSntCH3DAWN+QMIWEhYsqTD4wYHChrPfSP9kqnmM6QAMkYtz4xqmDqeGA+rLNObGZVozkglx1ZfqZAvC2ZGAz9RYlEbAlsLoNd+Kx5RqO5/njKXDsnKdhCXFOaFAZUzjznlhyt5xIjiSLbBz2oVO98fRdalOoGZ5m/dUQ4pvJZ3Zr/CXlS5A74gabzlYePztr6U2faxr+eRy/RYvtjgjHauvkxvi9oTDXaGBuAUJWyh1hb3vqsOvfiG5/L/yMAE483BqdNeuXO3LvcGX3vEUhsZVsaYL9IzACz3BXcVOXvQOfKRsupBZv8R4bnW19rmqGPzqHz4BcMGn5U/Hgod5oiT3P3kvVj7rrfnx/pHBu7d7Azc1eY3/l0drzWbPXNjsGXySy38AbtMqneWU7BkAAAAASUVORK5CYII=",googledrive:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QgPEA85ztzJcQAABZVJREFUWMPtl1uoXVcVhr8x5tprn7M1NG1i0pQqSG2jLcXipYJXjPogqFgpaHMSFUkpIjU+leKbDxIQSiHgjZgmrfXgQ6SKj5Ji7YVS05aUUqKQlNLQeDnN5Zzk9Jy99xy/D3OttU/StDlV33TBZM3FXmuMf/5jjv+fG/7XL1vti9tnv3Dtnnf+87JY8YmZNxEMM1sZ7tWpjz764mriVqvKvmfb1ONLy3+dGyWu6EWbvQwoydv5BMSqFuereakmfnls1GP25IDaBGYYjplhljDz5tk7YMtPfurAf6UE9Z6tNwDPAPXwtcxL1x9n4zRgDjjm1gCyC6JpCLoW/OX65of1nzCwG6gNo3aYeXF981mTvK2/WWFiMmoj7X+z5JcE0N87c4e7b3EvyTwZT5/r8ezZHu6GuWGpSegJ8/ZeBu6fHv35s1/7t0rQv29mjWF/ATZ1L4bQwohrpkYc/sBpwhJYAVdKYECzYAESIk4Am3sf+sPCW2LAzb9jbpvMDXfD3fEqkRIcGdbsevlt9LylPYG1K6/K3QzK75uAr78lBgb3b7sc2cl2Uaa21sDiGMvB2iQeu/EMm6bKHjD3SUsCEChnpEAKiLisd/PB+UsyMPjZNwzzh1ixcnOfsFCX51NU/PTvA6pkTUdYw4R3zyu1ArMDqyvBQB82+FiJUQJ4C8YgVT1SSvSTs+vEmkcwe7qEsUnt233Aij0BW4ZPbfngKpRQs7hXpYQNvRiuEtATWOW4bLi+z04pJbCnBAkBJggBQlIBIZCUJM0Cm9+QgcED2+/G7BprdMZaAFZExm1FWcz+NLdj32G/6XfPCB5GoJKp7H5FARHRtgRI1y0/+cm7Lwpg+v7t64DvNd5S2mqirKXHy6RoArp1Ykrc2hKtKCtXlNEyoQ6Ydi498fF1F2FAdwEbV9UnZne+8q19Z7o63vTb+TPnRneeWxwxHGdyziii6wApQNEydKUUd5wHYGrftvci7tKKLSME5bvCaruynI9rNL7vdZgiHhiP898Wl8bMnxty+uyIhcURo1FgjSg1DCDph4uPfuR9AFbvvS25p2cxbiyKVuh2o1O44n2lLLacb5v75v5fX6yl5h753IwUD+YcRAQ5B6FMMhj0jboSRhnAE258wvp7Z7aYcbCYCeCGt97ubfICLDP/q4WZ32x7M20fPfb+hxbH9ZdjHOQIIoR74EDywA3coa6MqtJnrP+LmRmcB63ob8dA1wllRm95LVc//22S16TGeKqqpqoHk10ESGJj/zjjgIhAISKCyJmcY6Uu8Pbq7C0V6ABh35dzvYWQG0QAhmSYCaUlNhzdCrlX2jpE6tV4b9DYcGFKEgG8svQucoicC4CsII8zeTxutAEQzx1duPL3vrxjdlnou0SDLdTulxJQmalXNzN98jpEJiSo+qTeoEnsnWC5lVZNRhkOZiq0G8XCmz1gpp3j/ZYdYLhj9qCkn3fJQ4QKeh9OccWxz6O0hGKM9wakeoBEZ1BmqfOMyYFk4gXS+edG4J4ju6/644VK+AOJhSIYpVRBpn/qPVRL65A51dRavJoG2UQkOqf0hgVrGG7u6syoJDObB+55nRANb589Afy40W0UwkY91h39CiLweg1UU+W3ohLNvC2VurJ1htR6A3QaYPCjI7uvOvGGOlfv2XoSuBzEhmNfZXDqBrweUPVqUlWodneSG+6J1NTevThfDpEjmnsmzuuCPPfCvRvfcakT0S2Aeq9tYPr0ZryeBvOOlZBKUIEiCAVZwTgy41x6v6hm0LFZ4o7N7IuXPA+EDx+XjQ+tP/4lUrW2vCI1ydR0iYgmWdtu4yzG7bOiAdn8iYlA0iFJh1Z1JJv+ye2b3n1419XRH2riP0aqqlKClABIjUMW+rtSlw5qmCpgsynnl56/d+M/+P91wfUvQjDgTzx9h9AAAAAASUVORK5CYII=",nocipherIcon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTYiIHdpZHRoPSIxNiIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iPgogPHBhdGggZD0ibSAxMy4yMDMxMjQsMTEuNzczNDM4IGMgMC4yODEyNSwwLjI4MTI1IDAuNDIxODc1LDAuNjA5Mzc1IDAuNDIxODc1LDEuMDMxMjUgMCwwLjM3NSAtMC4xNDA2MjUsMC43NSAtMC40MjE4NzUsMS4wMzEyNSAtMC4yODEyNSwwLjIzNDM3NSAtMC42MDkzNzUsMC4zNzUgLTEuMDMxMjUsMC4zNzUgLTAuMzc1LDAgLTAuNzUsLTAuMTQwNjI1IC0xLjAzMTI1LC0wLjM3NSAwLDAgLTMuMTg3NDk4MSwtMy42NTYyNSAtMy4xODc0OTgxLC0zLjY1NjI1IDAsMCAtMy4xNDA2MjUsMy42NTYyNSAtMy4xNDA2MjUsMy42NTYyNSAtMC4yODEyNSwwLjIzNDM3NSAtMC42NTYyNSwwLjM3NSAtMS4wMzEyNSwwLjM3NSAtMC40MjE4NzUsMCAtMC43NSwtMC4xNDA2MjUgLTEuMDMxMjUsLTAuMzc1IC0wLjI4MTI1LC0wLjI4MTI1IC0wLjM3NSwtMC42NTYyNSAtMC4zNzUsLTEuMDMxMjUgMCwtMC40MjE4NzUgMC4wOTM3NSwtMC43NSAwLjM3NSwtMS4wMzEyNSAwLDAgMy4zMjgxMjUsLTMuNzUwMDAwNSAzLjMyODEyNSwtMy43NTAwMDA1IDAsMCAtMy4zMjgxMjUsLTMuNzk2ODc1IC0zLjMyODEyNSwtMy43OTY4NzUgLTAuMjgxMjUsLTAuMjgxMjUgLTAuMzc1LC0wLjYwOTM3NSAtMC4zNzUsLTEuMDMxMjUgMCwtMC4zNzUgMC4wOTM3NSwtMC43NSAwLjM3NSwtMS4wMzEyNSAwLjI4MTI1LC0wLjIzNDM3NSAwLjYwOTM3NSwtMC4zNzUgMS4wMzEyNSwtMC4zNzUgMC4zNzUsMCAwLjc1LDAuMTQwNjI1IDEuMDMxMjUsMC4zNzUgMCwwIDMuMTQwNjI1LDMuNjU2MjUgMy4xNDA2MjUsMy42NTYyNSAwLDAgMy4xODc0OTgxLC0zLjY1NjI1IDMuMTg3NDk4MSwtMy42NTYyNSAwLjI4MTI1LC0wLjIzNDM3NSAwLjY1NjI1LC0wLjM3NSAxLjAzMTI1LC0wLjM3NSAwLjQyMTg3NSwwIDAuNzUsMC4xNDA2MjUgMS4wMzEyNSwwLjM3NSAwLjI4MTI1LDAuMjgxMjUgMC40MjE4NzUsMC42NTYyNSAwLjQyMTg3NSwxLjAzMTI1IDAsMC40MjE4NzUgLTAuMTQwNjI1LDAuNzUgLTAuNDIxODc1LDEuMDMxMjUgMCwwIC0zLjMyODEyMzEsMy43OTY4NzUgLTMuMzI4MTIzMSwzLjc5Njg3NSAwLDAgMy4zMjgxMjMxLDMuNzUwMDAwNSAzLjMyODEyMzEsMy43NTAwMDA1IiBmaWxsPSIjZmZmIi8+Cjwvc3ZnPgo=",remoteStorageIcon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzIiIHdpZHRoPSIzMiIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KIDxkZWZzPgogIDxyYWRpYWxHcmFkaWVudCBpZD0iYSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGN5PSI1NzEuNDIiIGN4PSIxMDQ2LjUiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoLjE0NDMzIDAgMCAuMTY2NjcgMTIwMS41IDg3Ny4xMSkiIHI9Ijk2Ij4KICAgPHN0b3Agc3RvcC1jb2xvcj0iI2ZmNGEwNCIgc3RvcC1vcGFjaXR5PSIuNzYxNTQiIG9mZnNldD0iMCIvPgogICA8c3RvcCBzdG9wLWNvbG9yPSIjZmY0YTA0IiBvZmZzZXQ9IjEiLz4KICA8L3JhZGlhbEdyYWRpZW50PgogPC9kZWZzPgogPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEzMzYuNiAtOTU2LjM1KSI+CiAgPHBhdGggc3R5bGU9ImNvbG9yOiMwMDAwMDAiIGQ9Im0xMzUyLjYgOTU2LjM1IDAuMjg4NiAxNS4xMzYgMTMuNTY3LTcuMTM1Mi0xMy44NTUtOC4wMDExemwtMTMuODU1IDguMDAxMSAxMy41NjcgNy4xMzUyIDAuMjg4Ny0xNS4xMzZ6bS0xMy44NTUgOC4wMDExdjE1Ljk5OGwxMi45NTgtNy44MTYyLTEyLjk1OC04LjE4MTV6bTAgMTUuOTk4IDEzLjg1NSA4LjAwMTEtMC42MDg5LTE1LjMxNy0xMy4yNDYgNy4zMTU2em0xMy44NTUgOC4wMDExIDEzLjg1NS04LjAwMTEtMTMuMjUxLTcuMzE1Ni0wLjYwNDQgMTUuMzE3em0xMy44NTUtOC4wMDExdi0xNS45OThsLTEyLjk2MiA4LjE4MTUgMTIuOTYyIDcuODE2MnoiIGZpbGw9InVybCgjYSkiLz4KIDwvZz4KPC9zdmc+Cg==",remoteStorageIconCiphered:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzIiIHdpZHRoPSIzMiIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KIDxkZWZzPgogIDxyYWRpYWxHcmFkaWVudCBpZD0iYSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGN5PSI1NzEuNDIiIGN4PSIxMDQ2LjUiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoLjE0NDMzIDAgMCAuMTY2NjcgMTIwMS41IDg3Ny4xMSkiIHI9Ijk2Ij4KICAgPHN0b3Agc3RvcC1jb2xvcj0iI2ZmNGEwNCIgc3RvcC1vcGFjaXR5PSIuNzYxNTQiIG9mZnNldD0iMCIvPgogICA8c3RvcCBzdG9wLWNvbG9yPSIjZmY0YTA0IiBvZmZzZXQ9IjEiLz4KICA8L3JhZGlhbEdyYWRpZW50PgogPC9kZWZzPgogPHBhdGggc3R5bGU9ImNvbG9yOiMwMDAwMDAiIGQ9Im0xNiAwbDAuMTI1IDYuMzc1YzIuMDk4IDAuMDY3IDMuNzUgMS43NTk1IDMuNzUgMy44NzV2MS45NjloMS45MzcgMC4wMzJsOC00LjIxOS0xMy44NDQtOHpsLTEzLjg0NCA4IDggNC4yMTloMC4wMzIgMS45MDZ2LTEuOTY5YzAtMi4xMTU1IDEuNjgzLTMuODA4IDMuNzgxLTMuODc1bDAuMTI1LTYuMzc1em0tMTMuODQ0IDh2MTZsNy45OTk4LTQuODQ0di02LjA5NGwtNy45OTk4LTUuMDYyem0wIDE2bDEzLjg0NCA4LTAuMzc1LTEwLjA2MmgtNS40Njl2LTIuMzQ0bC03Ljk5OTggNC40MDZ6bTEzLjg0NCA4bDEzLjg0NC04LTgtNC40MDZ2Mi4zNDRoLTUuNDY5bC0wLjM3NSAxMC4wNjJ6bTEzLjg0NC04di0xNmwtOCA1LjA2MnY2LjA5NGw4IDQuODQ0em0tMTMuOTY5LTE3Yy0xLjczNSAwLjA2NjYtMy4xMjUgMS40OTg3LTMuMTI1IDMuMjV2MS45NjloMy4wMzFsMC4wOTQtNS4yMTl6bTAuMjUgMGwwLjA5NCA1LjIxOWgzLjAzMXYtMS45NjljMC0xLjc1MTMtMS4zOS0zLjE4MzQtMy4xMjUtMy4yNXptLTQuNzUgNS44NDRsNC4zNDQgMi4yODEgMC4wMzEtMi4yODFoLTQuMzc1em00Ljg3NSAwbDAuMDMxIDIuMjgxIDQuMzQ0LTIuMjgxaC00LjM3NXptLTUuNDM4IDAuNjI1djUuMzEybDQuMjgyLTIuNTkzLTQuMjgyLTIuNzE5em0xMC4zNzYgMGwtNC4yODIgMi43MTkgNC4yODIgMi41OTN2LTUuMzEyem0tNS43ODIgMy4yMTlsLTQuNTk0IDIuNTMxdjIuMDYyaDQuNzgybC0wLjE4OC00LjU5M3ptMS4xODggMGwtMC4xODggNC41OTNoNC43ODJ2LTIuMDYybC00LjU5NC0yLjUzMXoiIGZpbGw9InVybCgjYSkiLz4KPC9zdmc+Cg==",remoteStorageIconError:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzIiIHdpZHRoPSIzMiIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KIDxkZWZzPgogIDxyYWRpYWxHcmFkaWVudCBpZD0iYSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGN5PSI1NzEuNDIiIGN4PSIxMDQ2LjUiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoLjE0NDMzIDAgMCAuMTY2NjcgMTIwMS41IDg3Ny4xMSkiIHI9Ijk2Ij4KICAgPHN0b3Agc3RvcC1jb2xvcj0iI2U5MDAwMCIgc3RvcC1vcGFjaXR5PSIuNzYwNzgiIG9mZnNldD0iMCIvPgogICA8c3RvcCBzdG9wLWNvbG9yPSIjZTkwMDAwIiBvZmZzZXQ9IjEiLz4KICA8L3JhZGlhbEdyYWRpZW50PgogPC9kZWZzPgogPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEzMzYuNiAtOTU2LjM1KSI+CiAgPHBhdGggc3R5bGU9ImNvbG9yOiMwMDAwMDAiIGQ9Im0xMzUyLjYgOTU2LjM1IDAuMjg4NiAxNS4xMzYgMTMuNTY3LTcuMTM1Mi0xMy44NTUtOC4wMDExemwtMTMuODU1IDguMDAxMSAxMy41NjcgNy4xMzUyIDAuMjg4Ny0xNS4xMzZ6bS0xMy44NTUgOC4wMDExdjE1Ljk5OGwxMi45NTgtNy44MTYyLTEyLjk1OC04LjE4MTV6bTAgMTUuOTk4IDEzLjg1NSA4LjAwMTEtMC42MDg5LTE1LjMxNy0xMy4yNDYgNy4zMTU2em0xMy44NTUgOC4wMDExIDEzLjg1NS04LjAwMTEtMTMuMjUxLTcuMzE1Ni0wLjYwNDQgMTUuMzE3em0xMy44NTUtOC4wMDExdi0xNS45OThsLTEyLjk2MiA4LjE4MTUgMTIuOTYyIDcuODE2MnoiIGZpbGw9InVybCgjYSkiLz4KIDwvZz4KPC9zdmc+Cg==",remoteStorageIconOffline:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzIiIHdpZHRoPSIzMiIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KIDxkZWZzPgogIDxyYWRpYWxHcmFkaWVudCBpZD0iYSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGN5PSI1NzEuNDIiIGN4PSIxMDQ2LjUiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoLjE0NDMzIDAgMCAuMTY2NjcgMTIwMS41IDg3Ny4xMSkiIHI9Ijk2Ij4KICAgPHN0b3Agc3RvcC1jb2xvcj0iIzY5Njk2OSIgc3RvcC1vcGFjaXR5PSIuNzYxNTQiIG9mZnNldD0iMCIvPgogICA8c3RvcCBzdG9wLWNvbG9yPSIjNjc2NzY3IiBvZmZzZXQ9IjEiLz4KICA8L3JhZGlhbEdyYWRpZW50PgogPC9kZWZzPgogPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEzMzYuNiAtOTU2LjM1KSI+CiAgPHBhdGggc3R5bGU9ImNvbG9yOiMwMDAwMDAiIGQ9Im0xMzUyLjYgOTU2LjM1IDAuMjg4NiAxNS4xMzYgMTMuNTY3LTcuMTM1Mi0xMy44NTUtOC4wMDExemwtMTMuODU1IDguMDAxMSAxMy41NjcgNy4xMzUyIDAuMjg4Ny0xNS4xMzZ6bS0xMy44NTUgOC4wMDExdjE1Ljk5OGwxMi45NTgtNy44MTYyLTEyLjk1OC04LjE4MTV6bTAgMTUuOTk4IDEzLjg1NSA4LjAwMTEtMC42MDg5LTE1LjMxNy0xMy4yNDYgNy4zMTU2em0xMy44NTUgOC4wMDExIDEzLjg1NS04LjAwMTEtMTMuMjUxLTcuMzE1Ni0wLjYwNDQgMTUuMzE3em0xMy44NTUtOC4wMDExdi0xNS45OThsLTEyLjk2MiA4LjE4MTUgMTIuOTYyIDcuODE2MnoiIGZpbGw9InVybCgjYSkiLz4KIDwvZz4KPC9zdmc+Cg==",syncIcon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDg3LjUgMTAwIiB4bWw6c3BhY2U9InByZXNlcnZlIiBoZWlnaHQ9IjE2IiB2aWV3Qm94PSIwIDAgMTUuOTk5OTk5IDE2IiB3aWR0aD0iMTYiIHZlcnNpb249IjEuMSIgeT0iMHB4IiB4PSIwcHgiIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyI+CjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC01LjUxMTIgLTc2LjUyNSkiIGRpc3BsYXk9Im5vbmUiPgoJPHBhdGggZGlzcGxheT0iaW5saW5lIiBkPSJtNTEuNDczIDQyLjI1NS0yLjIwNSAyLjIxMmMxLjQ3OCAxLjQ3NyAyLjI5NSAzLjQ0MiAyLjI5NSA1LjUzMyAwIDQuMzA5LTMuNTA0IDcuODEyLTcuODEyIDcuODEydi0xLjU2MmwtMy4xMjUgMy4xMjUgMy4xMjQgMy4xMjV2LTEuNTYyYzYuMDI5IDAgMTAuOTM4LTQuOTA2IDEwLjkzOC0xMC45MzggMC0yLjkyNy0xLjE0MS01LjY3Ni0zLjIxNS03Ljc0NXoiLz4KCTxwYXRoIGRpc3BsYXk9ImlubGluZSIgZD0ibTQ2Ljg3NSA0MC42MjUtMy4xMjUtMy4xMjV2MS41NjJjLTYuMDMgMC0xMC45MzggNC45MDctMTAuOTM4IDEwLjkzOCAwIDIuOTI3IDEuMTQxIDUuNjc2IDMuMjE3IDcuNzQ1bDIuMjAzLTIuMjEyYy0xLjQ3Ny0xLjQ3OS0yLjI5NC0zLjQ0Mi0yLjI5NC01LjUzMyAwLTQuMzA5IDMuNTA0LTcuODEyIDcuODEyLTcuODEydjEuNTYybDMuMTI1LTMuMTI1eiIvPgo8L2c+CjxwYXRoIGZpbGw9IiNmZmYiIGQ9Im0xMCAwbC0wLjc1IDEuOTA2MmMtMS4wMDc4LTAuMjk0Mi0zLjQ1ODYtMC43NzA4LTUuNjU2MiAwLjkzNzYgMC0wLjAwMDItMy45MzAyIDIuNTk0MS0yLjA5MzggNy41OTQybDEuNjU2Mi0wLjcxOTJzLTEuNTM5OS0zLjExMjIgMS42ODc2LTUuNTMxM2MwIDAgMS42OTU3LTEuMTMzOSAzLjY4NzQtMC41OTM3bC0wLjcxODcgMS44MTI0IDMuODEyNS0xLjYyNS0xLjYyNS0zLjc4MTJ6Ii8+PHBhdGggZmlsbD0iI2ZmZiIgZD0ibTE0IDUuNTYyNWwtMS42NTYgMC43MTg3czEuNTQxIDMuMTEzNS0xLjY4OCA1LjUzMDhjMCAwLTEuNzI3MiAxLjEzNS0zLjcxODUgMC41OTRsMC43NS0xLjgxMi0zLjgxMjUgMS41OTQgMS41OTM4IDMuODEyIDAuNzgxMi0xLjkwNmMxLjAxMTMgMC4yOTUgMy40NjE1IDAuNzY2IDUuNjU2LTAuOTM4IDAgMCAzLjkyOC0yLjU5NCAyLjA5NC03LjU5MzV6Ii8+Cjwvc3ZnPgo=",widget:'<div class="rs-bubble rs-hidden">   <div class="rs-bubble-text remotestorage-initial remotestorage-error remotestorage-authing remotestorage-offline">     <span class="rs-status-text">{{view_connect}}</span>   </div>   <div class="rs-bubble-expandable">     <!-- error -->     <div class="remotestorage-error">       <pre class="rs-status-text rs-error-msg">{{ERROR_MSG}}</pre>       <button class="remotestorage-reset">{{view_get_me_out}}</button>       <p class="rs-centered-text rs-error-plz-report">{{view_error_plz_report}}</p>     </div>     <!-- connected -->     <div class="rs-bubble-text remotestorage-connected">       <strong class="userAddress">{{USER_ADDRESS}}</strong>       <p class="remotestorage-unauthorized">{{view_unauthorized}}</p>       <p class="remotestorage-invalid-key">{{view_invalid_key}}</p>       <form novalidate class="remotestorage-cipher-form">         <input placeholder="Secret key" name="userSecretKey" novalidate>         <button class="rs-cipher" name="rs-cipher" title="cipher" disabled="disabled">           <img>         </button>         <button class="rs-nocipher" name="rs-nocipher" title="no cipher">           <img>         </button>       </form>     </div>     <div class="rs-content remotestorage-connected">       <button class="rs-sync" title="sync"><img></button>       <button class="rs-disconnect" title="disconnect"><img></button>     </div>     <!-- initial -->     <form novalidate class="remotestorage-initial">       <input type="email" placeholder="user@provider.com" name="userAddress" novalidate>       <button class="connect" name="connect" title="connect" disabled="disabled">         <img>       </button>     </form>     <div class="rs-info-msg remotestorage-initial">{{view_info}}</div>   </div> </div> <img class="rs-dropbox rs-backends rs-action" alt="Connect to Dropbox"> <img class="rs-googledrive rs-backends rs-action" alt="Connect to Google Drive"> <img class="rs-cube rs-action"> ',widgetCss:'/** encoding:utf-8 **/ /* RESET */ #remotestorage-widget{text-align:left;}#remotestorage-widget input, #remotestorage-widget button{font-size:11px;}#remotestorage-widget form input[type=email]{margin-bottom:0;/* HTML5 Boilerplate */}#remotestorage-widget form input[type=submit]{margin-top:0;/* HTML5 Boilerplate */}/* /RESET */ #remotestorage-widget, #remotestorage-widget *{-moz-box-sizing:border-box;box-sizing:border-box;}#remotestorage-widget{position:absolute;right:10px;top:10px;font:normal 16px/100% sans-serif !important;user-select:none;-webkit-user-select:none;-moz-user-select:-moz-none;cursor:default;z-index:10000;}#remotestorage-widget .rs-bubble{background:rgba(80, 80, 80, .7);border-radius:5px 15px 5px 5px;color:white;font-size:0.8em;padding:5px;position:absolute;right:3px;top:9px;min-height:24px;white-space:nowrap;text-decoration:none;}.rs-bubble .rs-bubble-text{padding-right:32px;/* make sure the bubble doesn\'t "jump" when initially opening. */ min-width:182px;}#remotestorage-widget .rs-action{cursor:pointer;}/* less obtrusive cube when connected */ #remotestorage-widget.remotestorage-state-connected .rs-cube, #remotestorage-widget.remotestorage-state-busy .rs-cube{opacity:.3;-webkit-transition:opacity .3s ease;-moz-transition:opacity .3s ease;-ms-transition:opacity .3s ease;-o-transition:opacity .3s ease;transition:opacity .3s ease;}#remotestorage-widget.remotestorage-state-connected:hover .rs-cube, #remotestorage-widget.remotestorage-state-busy:hover .rs-cube, #remotestorage-widget.remotestorage-state-connected .rs-bubble:not(.rs-hidden) + .rs-cube{opacity:1 !important;}#remotestorage-widget .rs-backends{position:relative;top:5px;right:0;}#remotestorage-widget .rs-cube{position:relative;top:5px;right:0;}/* pulsing animation for cube when loading */ #remotestorage-widget .rs-cube.remotestorage-loading{-webkit-animation:remotestorage-loading .5s ease-in-out infinite alternate;-moz-animation:remotestorage-loading .5s ease-in-out infinite alternate;-o-animation:remotestorage-loading .5s ease-in-out infinite alternate;-ms-animation:remotestorage-loading .5s ease-in-out infinite alternate;animation:remotestorage-loading .5s ease-in-out infinite alternate;}@-webkit-keyframes remotestorage-loading{to{opacity:.7}}@-moz-keyframes remotestorage-loading{to{opacity:.7}}@-o-keyframes remotestorage-loading{to{opacity:.7}}@-ms-keyframes remotestorage-loading{to{opacity:.7}}@keyframes remotestorage-loading{to{opacity:.7}}#remotestorage-widget a{text-decoration:underline;color:inherit;}#remotestorage-widget form{margin-top:.7em;position:relative;}#remotestorage-widget form input{display:table-cell;vertical-align:top;border:none;border-radius:6px;font-weight:bold;color:white;outline:none;line-height:1.5em;height:2em;}#remotestorage-widget form input:disabled{color:#999;background:#444 !important;cursor:default !important;}#remotestorage-widget form input[type=email]:focus, #remotestorage-widget form input[type=password]:focus{background:#223;}#remotestorage-widget form input[type=email], #remotestorage-widget form input[type=password]{background:#000;width:100%;height:26px;padding:0 30px 0 5px;border-top:1px solid #111;border-bottom:1px solid #999;}#remotestorage-widget form input[type=email]:focus, #remotestorage-widget form input[type=password]:focus{background:#223;}#remotestorage-widget button:focus, #remotestorage-widget input:focus{box-shadow:0 0 4px #ccc;}#remotestorage-widget form input[type=email]::-webkit-input-placeholder, #remotestorage-widget form input[type=password]::-webkit-input-placeholder{color:#999;}#remotestorage-widget form input[type=email]:-moz-placeholder, #remotestorage-widget form input[type=password]:-moz-placeholder{color:#999;}#remotestorage-widget form input[type=email]::-moz-placeholder, #remotestorage-widget form input[type=password]::-moz-placeholder{color:#999;}#remotestorage-widget form input[type=email]:-ms-input-placeholder, #remotestorage-widget form input[type=password]:-ms-input-placeholder{color:#999;}#remotestorage-widget form input[type=submit]{background:#000;cursor:pointer;padding:0 5px;}#remotestorage-widget form input[type=submit]:hover{background:#333;}#remotestorage-widget .rs-info-msg{font-size:10px;color:#eee;margin-top:0.7em;white-space:normal;}#remotestorage-widget .rs-info-msg.last-synced-message{display:inline;white-space:nowrap;margin-bottom:.7em}#remotestorage-widget .rs-info-msg a:hover, #remotestorage-widget .rs-info-msg a:active{color:#fff;}#remotestorage-widget button img{vertical-align:baseline;}#remotestorage-widget button{border:none;border-radius:6px;font-weight:bold;color:white;outline:none;line-height:1.5em;height:26px;width:26px;background:#000;cursor:pointer;margin:0;padding:5px;}#remotestorage-widget button:hover{background:#333;}#remotestorage-widget .rs-bubble button.connect, #remotestorage-widget .rs-bubble button.rs-cipher, #remotestorage-widget .rs-bubble button.rs-nocipher{display:block;background:none;position:absolute;right:0;top:0;opacity:1;/* increase clickable area of connect, rs-cipher & rs-nocipher buttons */ margin:-5px;padding:10px;width:36px;height:36px;}#remotestorage-widget .rs-bubble button.rs-cipher{width:46px;}#remotestorage-widget .rs-bubble button.rs-nocipher{height:26px;margin:0;padding:4px 5px 5px;right:-32px;width:26px;}#remotestorage-widget .rs-bubble button.connect:not([disabled]):hover, #remotestorage-widget .rs-bubble button.rs-cipher:not([disabled]):hover, #remotestorage-widget .rs-bubble button.rs-nocipher:not([disabled]):hover{background:rgba(150,150,150,.5);}#remotestorage-widget .rs-bubble button.connect[disabled], #remotestorage-widget .rs-bubble button.rs-cipher[disabled]{opacity:.5;cursor:default !important;}#remotestorage-widget .rs-bubble button.rs-sync{position:relative;left:-5px;bottom:-5px;padding:4px 4px 0 4px;background:#555;}#remotestorage-widget .rs-bubble button.rs-sync:hover{background:#444;}#remotestorage-widget .rs-bubble button.rs-disconnect{background:#721;position:absolute;right:0;bottom:0;padding:4px 4px 0 4px;}#remotestorage-widget .rs-bubble button.rs-disconnect:hover{background:#921;}#remotestorage-widget .remotestorage-error-info{color:#f92;}#remotestorage-widget .remotestorage-reset{width:100%;background:#721;}#remotestorage-widget .remotestorage-reset:hover{background:#921;}#remotestorage-widget .rs-bubble .rs-content{margin-top:7px;}#remotestorage-widget pre{user-select:initial;-webkit-user-select:initial;-moz-user-select:text;max-width:27em;margin-top:1em;overflow:auto;}#remotestorage-widget .rs-centered-text{text-align:center;}#remotestorage-widget .rs-bubble.rs-hidden{padding-bottom:2px;border-radius:5px 15px 15px 5px;}#remotestorage-widget .rs-error-msg{min-height:5em;}.rs-bubble.rs-hidden .rs-bubble-expandable{display:none;}.remotestorage-state-connected .rs-bubble.rs-hidden{display:none;}.remotestorage-connected{display:none;}.remotestorage-state-connected .remotestorage-connected{display:block;}.remotestorage-cipher-form{display:none;}.remotestorage-cipher .remotestorage-cipher-form{display:block;}.remotestorage-invalid-key{display:none;}.remotestorage-invalid-key.remotestorage-cipher-error{display:block;}.remotestorage-initial{display:none;}.remotestorage-state-initial .remotestorage-initial{display:block;}.remotestorage-error{display:none;}.remotestorage-state-error .remotestorage-error{display:block;}.remotestorage-state-authing .remotestorage-authing{display:block;}.remotestorage-state-offline .remotestorage-connected, .remotestorage-state-offline .remotestorage-offline{display:block;}.remotestorage-unauthorized{display:none;}.remotestorage-state-unauthorized .rs-bubble.rs-hidden{display:none;}.remotestorage-state-unauthorized .remotestorage-connected, .remotestorage-state-unauthorized .remotestorage-unauthorized{display:block;}.remotestorage-state-unauthorized .rs-sync{display:none;}.remotestorage-state-busy .rs-bubble.rs-hidden{display:none;}.remotestorage-state-busy .rs-bubble{display:block;}.remotestorage-state-busy .remotestorage-connected{display:block;}.remotestorage-state-authing .rs-bubble-expandable{display:none;}'},function(){function e(e,t){return RemoteStorage.log("[Widget] Producing stateSetter for",t),function(){RemoteStorage.log("[Widget] Setting state",t,arguments),i&&(localStorage[n]=t),e.view?(e.rs.remote&&e.view.setUserAddress(e.rs.remote.userAddress),e.view.setState(t,arguments)):e._rememberedState=t
}}function t(e){return function(t){t instanceof RemoteStorage.DiscoveryError?(console.error("Discovery failed",t,'"'+t.message+'"'),e.view.setState("initial",[t.message])):t instanceof RemoteStorage.SyncError?e.view.setState("offline",[]):t instanceof RemoteStorage.Unauthorized?e.view.setState("unauthorized"):(RemoteStorage.log("[Widget] Unknown error"),e.view.setState("error",[t]))}}function o(e){return"GET"===e.method&&e.isFolder?!1:!0}var i,n="remotestorage:widget:state",r={initial:!0,connected:!0,offline:!0};RemoteStorage.Widget=function(s){var a=this,c=0;if(this.rs=s,this.rs.remote.on("connected",e(this,"connected")),this.rs.on("disconnected",e(this,"initial")),this.rs.on("connecting",e(this,"authing")),this.rs.on("authing",e(this,"authing")),this.rs.on("error",t(this)),this.rs.remote&&(this.rs.remote.on("wire-busy",function(t){o(t)&&(c++,e(a,"busy")())}),this.rs.remote.on("wire-done",function(t){o(t)&&c--,0>=c&&t.success&&e(a,"connected")()})),i){var l=localStorage[n];l&&r[l]&&(this._rememberedState=l)}},RemoteStorage.Widget.prototype={display:function(e){return"string"==typeof e?e={domID:e}:e===void 0&&(e={}),this.view||this.setView(new RemoteStorage.Widget.View(this.rs)),this.view.display(e),this},linkWidgetToSync:function(){"object"==typeof this.rs.sync&&"function"==typeof this.rs.sync.sync?this.view.on("sync",this.rs.sync.sync.bind(this.rs.sync)):(RemoteStorage.log("[Widget] typeof this.rs.sync check fail",this.rs.sync),setTimeout(this.linkWidgetToSync.bind(this),1e3))},setView:function(t){this.view=t,this.view.on("connect",function(e){"string"==typeof e?this.rs.connect(e):e.special&&this.rs[e.special].connect(e)}.bind(this)),this.view.on("secret-entered",function(t){this.view.setUserSecretKey(t),e(this,"ciphered")()}.bind(this)),this.view.on("secret-cancelled",function(){e(this,"notciphered")()}.bind(this)),this.view.on("disconnect",this.rs.disconnect.bind(this.rs)),this.linkWidgetToSync();try{this.view.on("reset",function(){var e=RemoteStorage.Authorize.getLocation();this.rs.on("disconnected",e.reload.bind(e)),this.rs.disconnect()}.bind(this))}catch(o){if(!o.message||!o.message.match(/Unknown event/))throw o}this._rememberedState&&(setTimeout(e(this,this._rememberedState),0),delete this._rememberedState)}},RemoteStorage.prototype.displayWidget=function(e){return this.widget.display(e)},RemoteStorage.Widget._rs_init=function(e){i=e.localStorageAvailable(),e.widget||(e.widget=new RemoteStorage.Widget(e))},RemoteStorage.Widget._rs_supported=function(){return"undefined"!=typeof document}}("undefined"!=typeof window?window:global),function(e){function t(e,t){return e.classList.remove(t)}function o(e,t){return e.classList.add(t)}function i(e){"function"==typeof e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function n(e,t,o,i){var n=e.querySelector("."+t);if(o!==void 0){var r=n.querySelector("img");(r||n).src=RemoteStorage.Assets[o]}return n.addEventListener("click",i),n}function r(e){e.target.value?e.target.nextElementSibling.removeAttribute("disabled"):e.target.nextElementSibling.setAttribute("disabled","disabled")}var s=RemoteStorage.I18n.translate;RemoteStorage.Widget.View=function(e){if(this.rs=e,"undefined"==typeof document)throw"Widget not supported";RemoteStorage.eventHandling(this,"connect","secret-entered","secret-cancelled","disconnect","sync","display","reset");for(var t in this.events)this.events[t]=this.events[t].bind(this);this.hideBubbleOnBodyClick=function(e){for(var t=e.target;t!==document.body;t=t.parentElement)if("remotestorage-widget"===t.id)return;this.hideBubble()}.bind(this)},RemoteStorage.Widget.View.prototype={connectGdrive:function(){this._emit("connect",{special:"googledrive"})},connectDropbox:function(){this._emit("connect",{special:"dropbox"})},setState:function(e,t){RemoteStorage.log("[View] widget.view.setState(",e,",",t,");");var o=this.states[e];if(o===void 0)throw Error("Bad State assigned to view: "+e);o.apply(this,t)},setUserAddress:function(e){this.userAddress=e||"";var t;this.div&&(t=this.div.querySelector("form.remotestorage-initial").userAddress)&&(t.value=this.userAddress)},setUserSecretKey:function(e){this.userSecretKey=e},toggleBubble:function(e){0>this.bubble.className.search("rs-hidden")?this.hideBubble(e):this.showBubble(e)},hideBubble:function(){o(this.bubble,"rs-hidden"),document.body.removeEventListener("click",this.hideBubbleOnBodyClick)},showBubble:function(e){t(this.bubble,"rs-hidden"),e!==void 0&&i(e),document.body.addEventListener("click",this.hideBubbleOnBodyClick),this.div.querySelector(".remotestorage-connected").classList.contains("remotestorage-cipher")&&!this.userSecretKey?this.bubble.querySelector("form.remotestorage-cipher-form").userSecretKey.focus():this.bubble.querySelector("form.remotestorage-initial").userAddress.focus()},display:function(e){if(this.div!==void 0)return this.div;var t=document.createElement("div"),o=document.createElement("style");if(o.innerHTML=RemoteStorage.Assets.widgetCss,t.id="remotestorage-widget",t.innerHTML=RemoteStorage.Assets.widget,t.appendChild(o),e.domID){var i=document.getElementById(e.domID);if(!i)throw'Failed to find target DOM element with id="'+e.domID+'"';i.appendChild(t)}else document.body.appendChild(t);n(t,"rs-sync","syncIcon",this.events.sync),n(t,"rs-disconnect","disconnectIcon",this.events.disconnect),n(t,"remotestorage-reset",void 0,this.events.reset),n(t,"connect","connectIcon",this.events.connect),this.form=t.querySelector("form.remotestorage-initial");var s=this.form.userAddress;if(s.addEventListener("load",r),s.addEventListener("keyup",r),this.userAddress&&(s.value=this.userAddress),e.encryption){this.cipher=!0;var a=t.querySelector("form.remotestorage-cipher-form").userSecretKey;a.type="password",n(t,"rs-cipher","cipherIcon",this.events["secret-entered"]),a.addEventListener("load",r),a.addEventListener("keyup",r),n(t,"rs-nocipher","nocipherIcon",this.events["secret-cancelled"])}this.cube=n(t,"rs-cube","remoteStorageIcon",this.toggleBubble.bind(this)),n(t,"rs-dropbox","dropbox",this.connectDropbox.bind(this)),n(t,"rs-googledrive","googledrive",this.connectGdrive.bind(this));var c={INPUT:!0,BUTTON:!0,IMG:!0},l=function(e){c[e.target.tagName]||this.div.classList.contains("remotestorage-state-unauthorized")||this.showBubble(e)}.bind(this);return this.bubble=n(t,"rs-bubble",void 0,l),this.hideBubble(),this.div=t,this.states.initial.call(this),this.events.display.call(this),this.div},states:{initial:function(e){var o=this.cube,i=e||s("view_info");o.src=RemoteStorage.Assets.remoteStorageIcon,this._renderTranslatedInitialContent(),e?(o.src=RemoteStorage.Assets.remoteStorageIconError,t(this.cube,"remotestorage-loading"),this.showBubble(),setTimeout(function(){o.src=RemoteStorage.Assets.remoteStorageIcon},2e3)):this.hideBubble(),this.div.className="remotestorage-state-initial",this.userSecretKey&&delete this.userSecretKey;var n=1;this._activateBackend("dropbox")&&(n+=1),this._activateBackend("googledrive")&&(n+=1),this.div.querySelector(".rs-bubble-text").style.paddingRight=32*n+8+"px";var r=this.div.querySelector(".connect");this.form.userAddress.value&&r.removeAttribute("disabled");var a=this.div.querySelector(".rs-info-msg");a.innerHTML=i,e?a.classList.add("remotestorage-error-info"):a.classList.remove("remotestorage-error-info")},authing:function(){this.div.removeEventListener("click",this.events.connect),this.div.className="remotestorage-state-authing",this.div.querySelector(".rs-status-text").innerHTML=s("view_connecting",this.userAddress),o(this.cube,"remotestorage-loading")},connected:function(){var e=this.cube;this.div.className="remotestorage-state-connected",this.div.querySelector(".userAddress").innerHTML=this.userAddress,e.src=RemoteStorage.Assets.remoteStorageIcon,t(e,"remotestorage-loading"),this.cipher&&(this.userSecretKey?this.userSecretKeyError?(e.src=RemoteStorage.Assets.remoteStorageIconError,o(this.div.querySelector(".remotestorage-connected"),"remotestorage-cipher"),o(this.div.querySelector(".remotestorage-invalid-key"),"remotestorage-cipher-error"),this.showBubble(),setTimeout(function(){e.src=RemoteStorage.Assets.remoteStorageIcon},5e3)):(t(this.div.querySelector(".remotestorage-invalid-key"),"remotestorage-cipher-error"),e.src=RemoteStorage.Assets.remoteStorageIconCiphered):(o(this.div.querySelector(".remotestorage-connected"),"remotestorage-cipher"),this.showBubble()));var i={googledrive:this.div.querySelector(".rs-googledrive"),dropbox:this.div.querySelector(".rs-dropbox")};i.googledrive.style.display=i.dropbox.style.display="none",i[this.rs.backend]?(i[this.rs.backend].style.display="inline-block",this.div.querySelector(".rs-bubble-text").style.paddingRight="72px"):this.div.querySelector(".rs-bubble-text").style.paddingRight="40px"},ciphered:function(){this.div.querySelector("form.remotestorage-cipher-form").userSecretKey.value="",t(this.div.querySelector(".remotestorage-invalid-key"),"remotestorage-cipher-error"),t(this.div.querySelector(".remotestorage-connected"),"remotestorage-cipher"),this.cube.src=RemoteStorage.Assets.remoteStorageIconCiphered,this.hideBubble()},notciphered:function(){this.cipher=!1,t(this.div.querySelector(".remotestorage-invalid-key"),"remotestorage-cipher-error"),t(this.div.querySelector(".remotestorage-connected"),"remotestorage-cipher"),this.hideBubble()},busy:function(){this.div.className="remotestorage-state-busy",o(this.cube,"remotestorage-loading")},offline:function(){this.div.className="remotestorage-state-offline",this.cube.src=RemoteStorage.Assets.remoteStorageIconOffline,this.div.querySelector(".rs-status-text").innerHTML=s("view_offline")},error:function(e){var t=e;this.div.className="remotestorage-state-error",this.div.querySelector(".rs-bubble-text").innerHTML="<strong>"+s("view_error_occured")+"</strong>",e instanceof Error&&(t=e.message+"\n\n"+e.stack),this.div.querySelector(".rs-error-msg").textContent=t,this.cube.src=RemoteStorage.Assets.remoteStorageIconError,this.showBubble()},unauthorized:function(){this.div.className="remotestorage-state-unauthorized",this.cube.src=RemoteStorage.Assets.remoteStorageIconError,this.showBubble(),this.div.addEventListener("click",this.events.connect)}},events:{connect:function(e){i(e),e.preventDefault(),this._emit("connect",this.div.querySelector("form.remotestorage-initial").userAddress.value)},"secret-entered":function(e){i(e),e.preventDefault(),this._emit("secret-entered",this.div.querySelector("form.remotestorage-cipher-form").userSecretKey.value)},"secret-cancelled":function(e){i(e),e.preventDefault(),this._emit("secret-cancelled")},sync:function(e){i(e),e.preventDefault(),this._emit("sync")},disconnect:function(e){i(e),e.preventDefault(),this._emit("disconnect")},reset:function(t){t.preventDefault();var o=e.confirm(s("view_confirm_reset"));o&&this._emit("reset")},display:function(e){e&&e.preventDefault(),this._emit("display")}},_renderTranslatedInitialContent:function(){this.div.querySelector(".rs-status-text").innerHTML=s("view_connect"),this.div.querySelector(".remotestorage-reset").innerHTML=s("view_get_me_out"),this.div.querySelector(".rs-error-plz-report").innerHTML=s("view_error_plz_report"),this.div.querySelector(".remotestorage-unauthorized").innerHTML=s("view_unauthorized"),this.div.querySelector(".remotestorage-invalid-key").innerHTML=s("view_invalid_key")},_activateBackend:function(e){var t="rs-"+e;return this.rs.apiKeys[e]?(this.div.querySelector("."+t).style.display="inline-block",!0):(this.div.querySelector("."+t).style.display="none",!1)}}}("undefined"!=typeof window?window:global),function(e){function t(e,o){if(e===o)return!0;if("object"==typeof e&&"object"==typeof o){if(Array.isArray(e)!=Array.isArray(o))return!1;if(Array.isArray(e)){if(e.length!=o.length)return!1;for(var i=0;e.length>i;i++)if(!t(e[i],o[i]))return!1}else{for(var n in e)if(void 0===o[n]&&void 0!==e[n])return!1;for(var n in o)if(void 0===e[n]&&void 0!==o[n])return!1;for(var n in e)if(!t(e[n],o[n]))return!1}return!0}return!1}function o(e){var t=(e+"").replace(/^\s+|\s+$/g,"").match(/^([^:\/?#]+:)?(\/\/(?:[^:@]*(?::[^:@]*)?@)?(([^:\/?#]*)(?::(\d*))?))?([^?#]*)(\?[^#]*)?(#[\s\S]*)?/);return t?{href:t[0]||"",protocol:t[1]||"",authority:t[2]||"",host:t[3]||"",hostname:t[4]||"",port:t[5]||"",pathname:t[6]||"",search:t[7]||"",hash:t[8]||""}:null}function i(e,t){function i(e){var t=[];return e.replace(/^(\.\.?(\/|$))+/,"").replace(/\/(\.(\/|$))+/g,"/").replace(/\/\.\.$/,"/../").replace(/\/?[^\/]*/g,function(e){"/.."===e?t.pop():t.push(e)}),t.join("").replace(/^\//,"/"===e.charAt(0)?"/":"")}return t=o(t||""),e=o(e||""),t&&e?(t.protocol||e.protocol)+(t.protocol||t.authority?t.authority:e.authority)+i(t.protocol||t.authority||"/"===t.pathname.charAt(0)?t.pathname:t.pathname?(e.authority&&!e.pathname?"/":"")+e.pathname.slice(0,e.pathname.lastIndexOf("/")+1)+t.pathname:e.pathname)+(t.protocol||t.authority||t.pathname?t.search:t.search||e.search)+t.hash:null}function n(e,t){if(void 0==t?t=e.id:"string"==typeof e.id&&(t=i(t,e.id),e.id=t),"object"==typeof e)if(Array.isArray(e))for(var o=0;e.length>o;o++)n(e[o],t);else if("string"==typeof e.$ref)e.$ref=i(t,e.$ref);else for(var r in e)"enum"!=r&&n(e[r],t)}function r(e,t,o,i,n){if(void 0==e)throw Error("No code supplied for error: "+t);this.code=e,this.message=t,this.dataPath=o?o:"",this.schemaPath=i?i:"",this.subErrors=n?n:null}function s(e,t,o){if("string"==typeof t.id&&t.id.substring(0,o.length)==o){var i=t.id.substring(o.length);(o.length>0&&"/"==o.charAt(o.length-1)||"#"==i.charAt(0)||"?"==i.charAt(0))&&void 0==e[t.id]&&(e[t.id]=t)}if("object"==typeof t)for(var n in t)"enum"!=n&&"object"==typeof t[n]&&s(e,t[n],o);return e}var a=function(e,t){this.missing=[],this.schemas=e?Object.create(e.schemas):{},this.collectMultiple=t,this.errors=[],this.handleError=t?this.collectError:this.returnError};a.prototype.returnError=function(e){return e},a.prototype.collectError=function(e){return e&&this.errors.push(e),null},a.prototype.prefixErrors=function(e,t,o){for(var i=e;this.errors.length>i;i++)this.errors[i]=this.errors[i].prefixWith(t,o);return this},a.prototype.getSchema=function(e){if(void 0!=this.schemas[e]){var t=this.schemas[e];return t}var o=e,i="";if(-1!=e.indexOf("#")&&(i=e.substring(e.indexOf("#")+1),o=e.substring(0,e.indexOf("#"))),void 0!=this.schemas[o]){var t=this.schemas[o],n=decodeURIComponent(i);if(""==n)return t;if("/"!=n.charAt(0))return void 0;for(var r=n.split("/").slice(1),s=0;r.length>s;s++){var a=r[s].replace("~1","/").replace("~0","~");if(void 0==t[a]){t=void 0;break}t=t[a]}if(void 0!=t)return t}void 0==this.missing[o]&&(this.missing.push(o),this.missing[o]=o)},a.prototype.addSchema=function(e,t){var o={};o[e]=t,n(t,e),s(o,t,e);for(var i in o)this.schemas[i]=o[i];return o},a.prototype.validateAll=function(e,t,o,i){if(void 0!=t.$ref&&(t=this.getSchema(t.$ref),!t))return null;var n=this.errors.length,r=this.validateBasic(e,t)||this.validateNumeric(e,t)||this.validateString(e,t)||this.validateArray(e,t)||this.validateObject(e,t)||this.validateCombinations(e,t)||null;if(r||n!=this.errors.length)for(;o&&o.length||i&&i.length;){var s=o&&o.length?""+o.pop():null,a=i&&i.length?""+i.pop():null;r&&(r=r.prefixWith(s,a)),this.prefixErrors(n,s,a)}return this.handleError(r)},a.prototype.validateBasic=function(e,t){var o;return(o=this.validateType(e,t))?o.prefixWith(null,"type"):(o=this.validateEnum(e,t))?o.prefixWith(null,"type"):null},a.prototype.validateType=function(e,t){if(void 0==t.type)return null;var o=typeof e;null==e?o="null":Array.isArray(e)&&(o="array");var i=t.type;"object"!=typeof i&&(i=[i]);for(var n=0;i.length>n;n++){var s=i[n];if(s==o||"integer"==s&&"number"==o&&0==e%1)return null}return new r(c.INVALID_TYPE,"invalid data type: "+o)},a.prototype.validateEnum=function(e,o){if(void 0==o["enum"])return null;for(var i=0;o["enum"].length>i;i++){var n=o["enum"][i];if(t(e,n))return null}return new r(c.ENUM_MISMATCH,"No enum match for: "+JSON.stringify(e))},a.prototype.validateNumeric=function(e,t){return this.validateMultipleOf(e,t)||this.validateMinMax(e,t)||null},a.prototype.validateMultipleOf=function(e,t){var o=t.multipleOf||t.divisibleBy;return void 0==o?null:"number"==typeof e&&0!=e%o?new r(c.NUMBER_MULTIPLE_OF,"Value "+e+" is not a multiple of "+o):null},a.prototype.validateMinMax=function(e,t){if("number"!=typeof e)return null;if(void 0!=t.minimum){if(t.minimum>e)return new r(c.NUMBER_MINIMUM,"Value "+e+" is less than minimum "+t.minimum).prefixWith(null,"minimum");if(t.exclusiveMinimum&&e==t.minimum)return new r(c.NUMBER_MINIMUM_EXCLUSIVE,"Value "+e+" is equal to exclusive minimum "+t.minimum).prefixWith(null,"exclusiveMinimum")}if(void 0!=t.maximum){if(e>t.maximum)return new r(c.NUMBER_MAXIMUM,"Value "+e+" is greater than maximum "+t.maximum).prefixWith(null,"maximum");if(t.exclusiveMaximum&&e==t.maximum)return new r(c.NUMBER_MAXIMUM_EXCLUSIVE,"Value "+e+" is equal to exclusive maximum "+t.maximum).prefixWith(null,"exclusiveMaximum")}return null},a.prototype.validateString=function(e,t){return this.validateStringLength(e,t)||this.validateStringPattern(e,t)||null},a.prototype.validateStringLength=function(e,t){return"string"!=typeof e?null:void 0!=t.minLength&&e.length<t.minLength?new r(c.STRING_LENGTH_SHORT,"String is too short ("+e.length+" chars), minimum "+t.minLength).prefixWith(null,"minLength"):void 0!=t.maxLength&&e.length>t.maxLength?new r(c.STRING_LENGTH_LONG,"String is too long ("+e.length+" chars), maximum "+t.maxLength).prefixWith(null,"maxLength"):null},a.prototype.validateStringPattern=function(e,t){if("string"!=typeof e||void 0==t.pattern)return null;var o=RegExp(t.pattern);return o.test(e)?null:new r(c.STRING_PATTERN,"String does not match pattern").prefixWith(null,"pattern")},a.prototype.validateArray=function(e,t){return Array.isArray(e)?this.validateArrayLength(e,t)||this.validateArrayUniqueItems(e,t)||this.validateArrayItems(e,t)||null:null},a.prototype.validateArrayLength=function(e,t){if(void 0!=t.minItems&&e.length<t.minItems){var o=new r(c.ARRAY_LENGTH_SHORT,"Array is too short ("+e.length+"), minimum "+t.minItems).prefixWith(null,"minItems");if(this.handleError(o))return o}if(void 0!=t.maxItems&&e.length>t.maxItems){var o=new r(c.ARRAY_LENGTH_LONG,"Array is too long ("+e.length+" chars), maximum "+t.maxItems).prefixWith(null,"maxItems");if(this.handleError(o))return o}return null},a.prototype.validateArrayUniqueItems=function(e,o){if(o.uniqueItems)for(var i=0;e.length>i;i++)for(var n=i+1;e.length>n;n++)if(t(e[i],e[n])){var s=new r(c.ARRAY_UNIQUE,"Array items are not unique (indices "+i+" and "+n+")").prefixWith(null,"uniqueItems");if(this.handleError(s))return s}return null},a.prototype.validateArrayItems=function(e,t){if(void 0==t.items)return null;var o;if(Array.isArray(t.items)){for(var i=0;e.length>i;i++)if(t.items.length>i){if(o=this.validateAll(e[i],t.items[i],[i],["items",i]))return o}else if(void 0!=t.additionalItems)if("boolean"==typeof t.additionalItems){if(!t.additionalItems&&(o=new r(c.ARRAY_ADDITIONAL_ITEMS,"Additional items not allowed").prefixWith(""+i,"additionalItems"),this.handleError(o)))return o}else if(o=this.validateAll(e[i],t.additionalItems,[i],["additionalItems"]))return o}else for(var i=0;e.length>i;i++)if(o=this.validateAll(e[i],t.items,[i],["items"]))return o;return null},a.prototype.validateObject=function(e,t){return"object"!=typeof e||null==e||Array.isArray(e)?null:this.validateObjectMinMaxProperties(e,t)||this.validateObjectRequiredProperties(e,t)||this.validateObjectProperties(e,t)||this.validateObjectDependencies(e,t)||null},a.prototype.validateObjectMinMaxProperties=function(e,t){var o=Object.keys(e);if(void 0!=t.minProperties&&o.length<t.minProperties){var i=new r(c.OBJECT_PROPERTIES_MINIMUM,"Too few properties defined ("+o.length+"), minimum "+t.minProperties).prefixWith(null,"minProperties");if(this.handleError(i))return i}if(void 0!=t.maxProperties&&o.length>t.maxProperties){var i=new r(c.OBJECT_PROPERTIES_MAXIMUM,"Too many properties defined ("+o.length+"), maximum "+t.maxProperties).prefixWith(null,"maxProperties");if(this.handleError(i))return i}return null},a.prototype.validateObjectRequiredProperties=function(e,t){if(void 0!=t.required)for(var o=0;t.required.length>o;o++){var i=t.required[o];if(void 0===e[i]){var n=new r(c.OBJECT_REQUIRED,"Missing required property: "+i).prefixWith(null,""+o).prefixWith(null,"required");if(this.handleError(n))return n}}return null},a.prototype.validateObjectProperties=function(e,t){var o;for(var i in e){var n=!1;if(void 0!=t.properties&&void 0!=t.properties[i]&&(n=!0,o=this.validateAll(e[i],t.properties[i],[i],["properties",i])))return o;if(void 0!=t.patternProperties)for(var s in t.patternProperties){var a=RegExp(s);if(a.test(i)&&(n=!0,o=this.validateAll(e[i],t.patternProperties[s],[i],["patternProperties",s])))return o}if(!n&&void 0!=t.additionalProperties)if("boolean"==typeof t.additionalProperties){if(!t.additionalProperties&&(o=new r(c.OBJECT_ADDITIONAL_PROPERTIES,"Additional properties not allowed").prefixWith(i,"additionalProperties"),this.handleError(o)))return o}else if(o=this.validateAll(e[i],t.additionalProperties,[i],["additionalProperties"]))return o}return null},a.prototype.validateObjectDependencies=function(e,t){var o;if(void 0!=t.dependencies)for(var i in t.dependencies)if(void 0!==e[i]){var n=t.dependencies[i];if("string"==typeof n){if(void 0===e[n]&&(o=new r(c.OBJECT_DEPENDENCY_KEY,"Dependency failed - key must exist: "+n).prefixWith(null,i).prefixWith(null,"dependencies"),this.handleError(o)))return o}else if(Array.isArray(n))for(var s=0;n.length>s;s++){var a=n[s];if(void 0===e[a]&&(o=new r(c.OBJECT_DEPENDENCY_KEY,"Dependency failed - key must exist: "+a).prefixWith(null,""+s).prefixWith(null,i).prefixWith(null,"dependencies"),this.handleError(o)))return o}else if(o=this.validateAll(e,n,[],["dependencies",i]))return o}return null},a.prototype.validateCombinations=function(e,t){return this.validateAllOf(e,t)||this.validateAnyOf(e,t)||this.validateOneOf(e,t)||this.validateNot(e,t)||null},a.prototype.validateAllOf=function(e,t){if(void 0==t.allOf)return null;for(var o,i=0;t.allOf.length>i;i++){var n=t.allOf[i];if(o=this.validateAll(e,n,[],["allOf",i]))return o}return null},a.prototype.validateAnyOf=function(e,t){if(void 0==t.anyOf)return null;for(var o=[],i=this.errors.length,n=0;t.anyOf.length>n;n++){var s=t.anyOf[n],a=this.errors.length,l=this.validateAll(e,s,[],["anyOf",n]);if(null==l&&a==this.errors.length)return this.errors=this.errors.slice(0,i),null;l&&o.push(l.prefixWith(null,""+n).prefixWith(null,"anyOf"))}return o=o.concat(this.errors.slice(i)),this.errors=this.errors.slice(0,i),new r(c.ANY_OF_MISSING,'Data does not match any schemas from "anyOf"',"","/anyOf",o)},a.prototype.validateOneOf=function(e,t){if(void 0==t.oneOf)return null;for(var o=null,i=[],n=this.errors.length,s=0;t.oneOf.length>s;s++){var a=t.oneOf[s],l=this.errors.length,u=this.validateAll(e,a,[],["oneOf",s]);if(null==u&&l==this.errors.length){if(null!=o)return this.errors=this.errors.slice(0,n),new r(c.ONE_OF_MULTIPLE,'Data is valid against more than one schema from "oneOf": indices '+o+" and "+s,"","/oneOf");o=s}else u&&i.push(u.prefixWith(null,""+s).prefixWith(null,"oneOf"))}return null==o?(i=i.concat(this.errors.slice(n)),this.errors=this.errors.slice(0,n),new r(c.ONE_OF_MISSING,'Data does not match any schemas from "oneOf"',"","/oneOf",i)):(this.errors=this.errors.slice(0,n),null)},a.prototype.validateNot=function(e,t){if(void 0==t.not)return null;var o=this.errors.length,i=this.validateAll(e,t.not),n=this.errors.slice(o);return this.errors=this.errors.slice(0,o),null==i&&0==n.length?new r(c.NOT_PASSED,'Data matches schema from "not"',"","/not"):null};var c={INVALID_TYPE:0,ENUM_MISMATCH:1,ANY_OF_MISSING:10,ONE_OF_MISSING:11,ONE_OF_MULTIPLE:12,NOT_PASSED:13,NUMBER_MULTIPLE_OF:100,NUMBER_MINIMUM:101,NUMBER_MINIMUM_EXCLUSIVE:102,NUMBER_MAXIMUM:103,NUMBER_MAXIMUM_EXCLUSIVE:104,STRING_LENGTH_SHORT:200,STRING_LENGTH_LONG:201,STRING_PATTERN:202,OBJECT_PROPERTIES_MINIMUM:300,OBJECT_PROPERTIES_MAXIMUM:301,OBJECT_REQUIRED:302,OBJECT_ADDITIONAL_PROPERTIES:303,OBJECT_DEPENDENCY_KEY:304,ARRAY_LENGTH_SHORT:400,ARRAY_LENGTH_LONG:401,ARRAY_UNIQUE:402,ARRAY_ADDITIONAL_ITEMS:403};r.prototype={prefixWith:function(e,t){if(null!=e&&(e=e.replace("~","~0").replace("/","~1"),this.dataPath="/"+e+this.dataPath),null!=t&&(t=t.replace("~","~0").replace("/","~1"),this.schemaPath="/"+t+this.schemaPath),null!=this.subErrors)for(var o=0;this.subErrors.length>o;o++)this.subErrors[o].prefixWith(e,t);return this}};var l=new a,u={validate:function(e,t){var o=new a(l);"string"==typeof t&&(t={$ref:t}),o.addSchema("",t);var i=o.validateAll(e,t);return this.error=i,this.missing=o.missing,this.valid=null==i,this.valid},validateResult:function(){var e={};return this.validate.apply(e,arguments),e},validateMultiple:function(e,t){var o=new a(l,!0);"string"==typeof t&&(t={$ref:t}),o.addSchema("",t),o.validateAll(e,t);var i={};return i.errors=o.errors,i.missing=o.missing,i.valid=0==i.errors.length,i},addSchema:function(e,t){return l.addSchema(e,t)},getSchema:function(e){return l.getSchema(e)},missing:[],error:null,normSchema:n,resolveUrl:i,errorCodes:c};e.tv4=u}("undefined"!=typeof window?window:global);var CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(e,t){var o,i=CHARS,n=[];if(t=t||i.length,e)for(o=0;e>o;o++)n[o]=i[0|Math.random()*t];else{var r;for(n[8]=n[13]=n[18]=n[23]="-",n[14]="4",o=0;36>o;o++)n[o]||(r=0|16*Math.random(),n[o]=i[19==o?8|3&r:r])}return n.join("")},function(){function e(e,t){console.log("WARNING: "+e+" is deprecated. Use "+t+" instead.")}var t=RemoteStorage;t.BaseClient=function(e,o){if("/"!==o[o.length-1])throw"Not a folder: "+o;"/"===o&&(this.makePath=function(e){return("/"===e[0]?"":"/")+e}),this.storage=e,this.base=o;var i=this.base.split("/");this.moduleName=i.length>2?i[1]:"root",t.eventHandling(this,"change"),this.on=this.on.bind(this),e.onChange(this.base,this._fireChange.bind(this))},t.BaseClient.prototype={extend:function(e){for(var t in e)this[t]=e[t];return this},scope:function(e){return new t.BaseClient(this.storage,this.makePath(e))},getListing:function(e,t){if("string"!=typeof e)e="";else if(e.length>0&&"/"!==e[e.length-1])throw"Not a folder: "+e;return this.storage.get(this.makePath(e),t).then(function(e,t){return 404===e?{}:t})},getAll:function(e,t){if("string"!=typeof e)e="";else if(e.length>0&&"/"!==e[e.length-1])throw"Not a folder: "+e;return this.storage.get(this.makePath(e),t).then(function(o,i){if(404===o)return{};if("object"==typeof i){var n=promising(),r=Object.keys(i).length,s=0;if(0===r)return{};for(var a in i)this.storage.get(this.makePath(e+a),t).then(function(e,t){if("string"==typeof t)try{t=JSON.parse(t)}catch(o){}"object"==typeof t&&(i[this.key]=t),s++,s===r&&n.fulfill(i)}.bind({key:a}));return n}}.bind(this))},getFile:function(e,t){return"string"!=typeof e?promising().reject("Argument 'path' of baseClient.getFile must be a string"):this.storage.get(this.makePath(e),t).then(function(e,t,o,i){return{data:t,mimeType:o,revision:i}})},storeFile:function(e,t,o){if("string"!=typeof e)return promising().reject("Argument 'mimeType' of baseClient.storeFile must be a string");if("string"!=typeof t)return promising().reject("Argument 'path' of baseClient.storeFile must be a string");if("string"!=typeof o&&"object"!=typeof o)return promising().reject("Argument 'body' of baseClient.storeFile must be a string, ArrayBuffer, or ArrayBufferView");this.storage.access.checkPathPermission(this.makePath(t),"rw")||console.warn("WARNING: Editing a document to which only read access ('r') was claimed");var i=this;return this.storage.put(this.makePath(t),o,e).then(function(e,o,n,r){if(200===e||201===e)return r;throw"Request (PUT "+i.makePath(t)+") failed with status: "+e})},getObject:function(e,t){return"string"!=typeof e?promising().reject("Argument 'path' of baseClient.getObject must be a string"):this.storage.get(this.makePath(e),t).then(function(t,o){if("object"==typeof o)return o;if("string"==typeof o)try{return JSON.parse(o)}catch(i){throw"Not valid JSON: "+this.makePath(e)}else if(o!==void 0&&200===t)throw"Not an object: "+this.makePath(e)})},storeObject:function(e,t,o){if("string"!=typeof e)return promising().reject("Argument 'typeAlias' of baseClient.storeObject must be a string");if("string"!=typeof t)return promising().reject("Argument 'path' of baseClient.storeObject must be a string");if("object"!=typeof o)return promising().reject("Argument 'object' of baseClient.storeObject must be an object");this._attachType(o,e);try{var i=this.validate(o);if(!i.valid)return promising(function(e){e.reject(i)})}catch(n){return promising().reject(n)}return this.storage.put(this.makePath(t),JSON.stringify(o),"application/json; charset=UTF-8").then(function(e,o,i,n){if(200===e||201===e)return n;throw"Request (PUT "+this.makePath(t)+") failed with status: "+e}.bind(this))},remove:function(e){return"string"!=typeof e?promising().reject("Argument 'path' of baseClient.remove must be a string"):(this.storage.access.checkPathPermission(this.makePath(e),"rw")||console.warn("WARNING: Removing a document to which only read access ('r') was claimed"),this.storage.delete(this.makePath(e)))},cache:function(t,o){if("string"!=typeof t)throw"Argument 'path' of baseClient.cache must be a string";if(o===!1?(e("caching strategy <false>",'<"FLUSH">'),o="FLUSH"):void 0===o?o="ALL":"string"!=typeof o&&(e("that caching strategy",'<"ALL">'),o="ALL"),"FLUSH"!==o&&"SEEN"!==o&&"ALL"!==o)throw'Argument \'strategy\' of baseclient.cache must be one of ["FLUSH", "SEEN", "ALL"]';return this.storage.caching.set(this.makePath(t),o),this},flush:function(e){return this.storage.local.flush(e)},makePath:function(e){return this.base+(e||"")},_fireChange:function(e){RemoteStorage.config.changeEvents[e.origin]&&(["new","old","lastCommon"].forEach(function(t){if((!e[t+"ContentType"]||/^application\/(.*)json(.*)/.exec(e[t+"ContentType"]))&&"string"==typeof e[t+"Value"])try{e[t+"Value"]=JSON.parse(e[t+"Value"])}catch(o){}}),this._emit("change",e))},_cleanPath:t.WireClient.cleanPath,getItemURL:function(e){if("string"!=typeof e)throw"Argument 'path' of baseClient.getItemURL must be a string";return this.storage.connected?(e=this._cleanPath(this.makePath(e)),this.storage.remote.href+e):void 0},uuid:function(){return Math.uuid()}},t.BaseClient._rs_init=function(){t.prototype.scope=function(e){if("string"!=typeof e)throw"Argument 'path' of baseClient.scope must be a string";if(!this.access.checkPathPermission(e,"r")){var o=e.replace(/(['\\])/g,"\\$1");console.warn("WARNING: please call remoteStorage.access.claim('"+o+"', 'r') (read only) or remoteStorage.access.claim('"+o+"', 'rw') (read/write) first")}return new t.BaseClient(this,e)}}}("undefined"!=typeof window?window:global),function(){RemoteStorage.BaseClient.Types={uris:{},schemas:{},aliases:{},declare:function(e,t,o,i){var n=e+"/"+t;if(i.extends){var r,s=i.extends.split("/");r=1===s.length?e+"/"+s.shift():s.join("/");var a=this.uris[r];if(!a)throw"Type '"+n+"' tries to extend unknown schema '"+r+"'";i.extends=this.schemas[a]}this.uris[n]=o,this.aliases[o]=n,this.schemas[o]=i},resolveAlias:function(e){return this.uris[e]},getSchema:function(e){return this.schemas[e]},inScope:function(e){var t=e.length,o={};for(var i in this.uris)if(i.substr(0,t+1)===e+"/"){var n=this.uris[i];o[n]=this.schemas[n]}return o}};var e=function(e){var t=Error("Schema not found: "+e);return t.name="SchemaNotFound",t};e.prototype=Error.prototype,RemoteStorage.BaseClient.Types.SchemaNotFound=e,RemoteStorage.BaseClient.prototype.extend({declareType:function(e,t,o){o||(o=t,t=this._defaultTypeURI(e)),RemoteStorage.BaseClient.Types.declare(this.moduleName,e,t,o)},validate:function(t){var o=RemoteStorage.BaseClient.Types.getSchema(t["@context"]);if(o)return tv4.validateResult(t,o);throw new e(t["@context"])},_defaultTypeURI:function(e){return"http://remotestorage.io/spec/modules/"+encodeURIComponent(this.moduleName)+"/"+encodeURIComponent(e)
},_attachType:function(e,t){e["@context"]=RemoteStorage.BaseClient.Types.resolveAlias(this.moduleName+"/"+t)||this._defaultTypeURI(t)}}),Object.defineProperty(RemoteStorage.BaseClient.prototype,"schemas",{configurable:!0,get:function(){return RemoteStorage.BaseClient.Types.inScope(this.moduleName)}})}("undefined"!=typeof window?window:global),function(){var e=RemoteStorage.util.containingFolder;RemoteStorage.Caching=function(){this.reset()},RemoteStorage.Caching.prototype={pendingActivations:[],set:function(e,t){if("string"!=typeof e)throw Error("path should be a string");if(t===void 0)throw Error("value should be 'FLUSH', 'SEEN', or 'ALL'");this._rootPaths[e]=t,"ALL"===t&&(this.activateHandler?this.activateHandler(e):this.pendingActivations.push(e))},enable:function(e){this.set(e,"ALL")},disable:function(e){this.set(e,"FLUSH")},onActivate:function(e){var t;for(RemoteStorage.log("[Caching] Setting activate handler",e,this.pendingActivations),this.activateHandler=e,t=0;this.pendingActivations.length>t;t++)e(this.pendingActivations[t]);delete this.pendingActivations},checkPath:function(t){return void 0!==this._rootPaths[t]?this._rootPaths[t]:"/"===t?"SEEN":this.checkPath(e(t))},reset:function(){this._rootPaths={}}},Object.defineProperty(RemoteStorage.prototype,"caching",{configurable:!0,get:function(){var e=new RemoteStorage.Caching;return Object.defineProperty(this,"caching",{value:e}),e}}),RemoteStorage.Caching._rs_init=function(){}}("undefined"!=typeof window?window:global),function(){function e(e,t,o){return{action:e,path:t,promise:o}}function t(e){return e.remote&&e.remote.revision&&!e.remote.itemsMap&&!e.remote.body}function o(e){return e.common&&e.common.revision}function n(){function e(e){var o,i;o=t.getCurrentSyncInterval(),c=!e,i=t.getCurrentSyncInterval(),t._emit("sync-interval-change",{oldValue:o,newValue:i})}var t=this;RemoteStorage.Env.on("background",function(){e(!1)}),RemoteStorage.Env.on("foreground",function(){e(!0)})}function r(e){return"number"==typeof e&&e>1e3&&36e5>e}var s=1e4,a=6e4,c=!1,l=RemoteStorage.util.isFolder,u=RemoteStorage.util.isDocument,d=RemoteStorage.util.equal,h=RemoteStorage.util.equalObj,g=RemoteStorage.util.deepClone,m=RemoteStorage.util.pathsFromRoot;RemoteStorage.Sync=function(e,t,o,i){this.local=e,this.local.onDiff(function(e){this.addTask(e),this.doTasks()}.bind(this)),this.remote=t,this.access=o,this.caching=i,this._tasks={},this._running={},this._timeStarted={},RemoteStorage.eventHandling(this,"done","req-done"),this.caching.onActivate(function(e){this.addTask(e),this.doTasks()}.bind(this))},RemoteStorage.Sync.prototype={now:function(){return(new Date).getTime()},queueGetRequest:function(e,t){this.remote.connected?this.remote.online?(this.addTask(e,function(){this.local.get(e).then(function(e,o,i){t.fulfill(e,o,i)})}.bind(this)),this.doTasks()):t.reject("cannot fulfill maxAge requirement - remote is not online"):t.reject("cannot fulfill maxAge requirement - remote is not connected")},corruptServerItemsMap:function(e,t){if("object"!=typeof e||Array.isArray(e))return!0;for(var o in e){var i=e[o];if("object"!=typeof i)return!0;if("string"!=typeof i.ETag)return!0;if(l(o)){if(-1!==o.substring(0,o.length-1).indexOf("/"))return!0}else{if(-1!==o.indexOf("/"))return!0;if(t){if("string"!=typeof i["Content-Type"])return!0;if("number"!=typeof i["Content-Length"])return!0}}}return!1},corruptItemsMap:function(e){if("object"!=typeof e||Array.isArray(e))return!0;for(var t in e)if("boolean"!=typeof e[t])return!0;return!1},corruptRevision:function(e){return"object"!=typeof e||Array.isArray(e)||e.revision&&"string"!=typeof e.revision||e.body&&"string"!=typeof e.body&&"object"!=typeof e.body||e.contentType&&"string"!=typeof e.contentType||e.contentLength&&"number"!=typeof e.contentLength||e.timestamp&&"number"!=typeof e.timestamp||e.itemsMap&&this.corruptItemsMap(e.itemsMap)},isCorrupt:function(e){return"object"!=typeof e||Array.isArray(e)||"string"!=typeof e.path||this.corruptRevision(e.common)||e.local&&this.corruptRevision(e.local)||e.remote&&this.corruptRevision(e.remote)||e.push&&this.corruptRevision(e.push)},hasTasks:function(){return Object.getOwnPropertyNames(this._tasks).length>0},collectDiffTasks:function(){var e=0;return this.local.forAllNodes(function(t){e>100||(this.isCorrupt(t)?(RemoteStorage.log("[Sync] WARNING: corrupt node in local cache",t),"object"==typeof t&&t.path&&(this.addTask(t.path),e++)):this.needsFetch(t)&&this.access.checkPathPermission(t.path,"r")?(this.addTask(t.path),e++):u(t.path)&&this.needsPush(t)&&this.access.checkPathPermission(t.path,"rw")&&(this.addTask(t.path),e++))}.bind(this)).then(function(){return e},function(e){throw e})},inConflict:function(e){return e.local&&e.remote&&(void 0!==e.remote.body||e.remote.itemsMap)},needsRefresh:function(e){return e.common?e.common.timestamp?this.now()-e.common.timestamp>s:!0:!1},needsFetch:function(e){return this.inConflict(e)?!0:e.common&&void 0===e.common.itemsMap&&void 0===e.common.body?!0:e.remote&&void 0===e.remote.itemsMap&&void 0===e.remote.body?!0:!1},needsPush:function(e){return this.inConflict(e)?!1:e.local&&!e.push?!0:void 0},needsRemotePut:function(e){return e.local&&e.local.body},needsRemoteDelete:function(e){return e.local&&e.local.body===!1},getParentPath:function(e){var t=e.match(/^(.*\/)([^\/]+\/?)$/);if(t)return t[1];throw Error('Not a valid path: "'+e+'"')},deleteChildPathsFromTasks:function(){for(var e in this._tasks){paths=m(e);for(var t=1;paths.length>t;t++)this._tasks[paths[t]]&&delete this._tasks[e]}},collectRefreshTasks:function(){return this.local.forAllNodes(function(e){var t;if(this.needsRefresh(e)){try{t=this.getParentPath(e.path)}catch(o){}t&&this.access.checkPathPermission(t,"r")?this.addTask(t):this.access.checkPathPermission(e.path,"r")&&this.addTask(e.path)}}.bind(this)).then(function(){this.deleteChildPathsFromTasks()}.bind(this),function(e){throw e})},flush:function(e){for(var t in e)"FLUSH"===this.caching.checkPath(t)&&e[t]&&!e[t].local&&(RemoteStorage.log("[Sync] Flushing",t),e[t]=void 0);return e},doTask:function(i){var n=this.local.getNodes([i]).then(function(n){var r=n[i];return r===void 0?e("get",i,this.remote.get(i)):t(r)?e("get",i,this.remote.get(i)):this.needsRemotePut(r)?(r.push=g(r.local),r.push.timestamp=this.now(),this.local.setNodes(this.flush(n)).then(function(){var t;return t=o(r)?{ifMatch:r.common.revision}:{ifNoneMatch:"*"},e("put",i,this.remote.put(i,r.push.body,r.push.contentType,t))}.bind(this))):this.needsRemoteDelete(r)?(r.push={body:!1,timestamp:this.now()},this.local.setNodes(this.flush(n)).then(function(){return o(r)?e("delete",i,this.remote.delete(i,{ifMatch:r.common.revision})):e("get",i,this.remote.get(i))}.bind(this))):o(r)?e("get",i,this.remote.get(i,{ifNoneMatch:r.common.revision})):e("get",i,this.remote.get(i))}.bind(this));return n},autoMergeFolder:function(e){if(e.remote.itemsMap&&(e.common=e.remote,delete e.remote,e.common.itemsMap)){for(var t in e.common.itemsMap)e.local.itemsMap[t]||(e.local.itemsMap[t]=!1);h(e.local.itemsMap,e.common.itemsMap)&&delete e.local}return e},autoMergeDocument:function(e){return hasNoRemoteChanges=function(e){return e.remote&&e.remote.revision&&e.remote.revision!==e.common.revision?!1:void 0===e.common.body&&e.remote.body===!1||e.remote.body===e.common.body&&e.remote.contentType===e.common.contentType},mergeMutualDeletion=function(e){return e.remote&&e.remote.body===!1&&e.local&&e.local.body===!1&&delete e.local,e},hasNoRemoteChanges(e)?(e=mergeMutualDeletion(e),delete e.remote):void 0!==e.remote.body&&(RemoteStorage.log("[Sync] Emitting keep/revert"),this.local._emitChange({origin:"conflict",path:e.path,oldValue:e.local.body,newValue:e.remote.body,lastCommonValue:e.common.body,oldContentType:e.local.contentType,newContentType:e.remote.contentType,lastCommonContentType:e.common.contentType}),e.common=e.remote.body?e.remote:{},delete e.remote,delete e.local),e},autoMerge:function(e){if(!e.remote)return e.common.body&&this.local._emitChange({origin:"remote",path:e.path,oldValue:e.common.body,newValue:void 0,oldContentType:e.common.contentType,newContentType:void 0}),void 0;if(e.local)return l(e.path)?this.autoMergeFolder(e):this.autoMergeDocument(e);if(l(e.path))void 0!==e.remote.itemsMap&&(e.common=e.remote,delete e.remote);else if(void 0!==e.remote.body){var t={origin:"remote",path:e.path,oldValue:e.common.body===!1?void 0:e.common.body,newValue:e.remote.body===!1?void 0:e.remote.body,oldContentType:e.common.contentType,newContentType:e.remote.contentType};if((t.oldValue||t.newValue)&&this.local._emitChange(t),!e.remote.body)return;e.common=e.remote,delete e.remote}return e},updateCommonTimestamp:function(e,t){return this.local.getNodes([e]).then(function(o){return o[e]&&o[e].common&&o[e].common.revision===t&&(o[e].common.timestamp=this.now()),this.local.setNodes(this.flush(o))}.bind(this))},markChildren:function(e,t,o,i){var n=[],r={},s={};for(var a in t)n.push(e+a),r[e+a]=t[a];for(var c in i)n.push(e+c);return this.local.getNodes(n).then(function(t){var n,a;nodeChanged=function(e,t){return e.common.revision!==t&&(!e.remote||e.remote.revision!==t)};for(var c in t)if(a=t[c],r[c])a&&a.common?nodeChanged(a,r[c].ETag)&&(o[c]=g(a),o[c].remote={revision:r[c].ETag,timestamp:this.now()},o[c]=this.autoMerge(o[c])):(n=this.caching.checkPath(c),"ALL"===n&&(o[c]={path:c,common:{timestamp:this.now()},remote:{revision:r[c].ETag,timestamp:this.now()}})),o[c]&&r[c]["Content-Type"]&&(o[c].remote.contentType=r[c]["Content-Type"]),o[c]&&r[c]["Content-Length"]&&(o[c].remote.contentLength=r[c]["Content-Length"]);else if(i[c.substring(e.length)]&&a&&a.common){if(a.common.itemsMap)for(var u in a.common.itemsMap)s[c+u]=!0;if(a.local&&a.local.itemsMap)for(var d in a.local.itemsMap)s[c+d]=!0;if(a.remote||l(c))o[c]=void 0;else if(o[c]=this.autoMerge(a),o[c]===void 0){var m=this.getParentPath(c),f=o[m],p=c.substring(e.length);f&&f.local&&(delete f.local.itemsMap[p],h(f.local.itemsMap,f.common.itemsMap)&&delete f.local)}}return this.deleteRemoteTrees(Object.keys(s),o).then(function(e){return this.local.setNodes(this.flush(e))}.bind(this))}.bind(this))},deleteRemoteTrees:function(e,t){return 0===e.length?promising().fulfill(t):this.local.getNodes(e).then(function(e){var o={};collectSubPaths=function(e,t){if(e&&e.itemsMap)for(var i in e.itemsMap)o[t+i]=!0};for(var i in e){var n=e[i];n&&(l(i)?(collectSubPaths(n.common,i),collectSubPaths(n.local,i)):n.common&&void 0!==typeof n.common.body&&(t[i]=g(n),t[i].remote={body:!1,timestamp:this.now()},t[i]=this.autoMerge(t[i])))}return this.deleteRemoteTrees(Object.keys(o),t).then(function(e){return this.local.setNodes(this.flush(e))}.bind(this))}.bind(this))},completeFetch:function(e,t,o,i){var n,r,s=m(e);l(e)?n=[e]:(r=s[1],n=[e,r]);var a=this.local.getNodes(n).then(function(n){var s,a,c={},u=n[e];if(collectMissingChildren=function(e){if(e&&e.itemsMap)for(var o in e.itemsMap)t[o]||(c[o]=!0)},("object"!=typeof u||u.path!==e||"object"!=typeof u.common)&&(u={path:e,common:{}},n[e]=u),u.remote={revision:i,timestamp:this.now()},l(e)){collectMissingChildren(u.common),collectMissingChildren(u.remote),u.remote.itemsMap={};for(s in t)u.remote.itemsMap[s]=!0}else u.remote.body=t,u.remote.contentType=o,a=n[r],a&&a.local&&a.local.itemsMap&&(s=e.substring(r.length),a.local.itemsMap[s]=!0,h(a.local.itemsMap,a.common.itemsMap)&&delete a.local);return n[e]=this.autoMerge(u),{toBeSaved:n,missingChildren:c}}.bind(this));return a},completePush:function(e,t,o,i){var n=this.local.getNodes([e]).then(function(n){var r=n[e];if(!r.push)throw this.stopped=!0,Error("completePush called but no push version!");return o?(RemoteStorage.log("[Sync] We have a conflict"),r.remote&&r.remote.revision===i||(r.remote={revision:i||"conflict",timestamp:this.now()},delete r.push),n[e]=this.autoMerge(r)):(r.common={revision:i,timestamp:this.now()},"put"===t?(r.common.body=r.push.body,r.common.contentType=r.push.contentType,d(r.local.body,r.push.body)&&r.local.contentType===r.push.contentType&&delete r.local,delete r.push):"delete"===t&&(r.local.body===!1?n[e]=void 0:delete r.push)),this.local.setNodes(this.flush(n))}.bind(this));return n},dealWithFailure:function(e){return this.local.getNodes([e]).then(function(t){return t[e]?(delete t[e].push,this.local.setNodes(this.flush(t))):void 0}.bind(this))},interpretStatus:function(e){if("offline"===e||"timeout"===e)return{successful:!1,networkProblems:!0,statusCode:e};var t=Math.floor(e/100);return{successful:2===t||304===e||412===e||404===e,conflict:412===e,unAuth:401===e&&this.remote.token!==RemoteStorage.Authorize.IMPLIED_FAKE_TOKEN||402===e||403===e,notFound:404===e,changed:304!==e,statusCode:e}},handleGetResponse:function(e,t,o,i,n){return t.notFound&&(o=l(e)?{}:!1),t.changed?this.completeFetch(e,o,i,n).then(function(t){return l(e)?this.corruptServerItemsMap(o)?(RemoteStorage.log("[Sync] WARNING: Discarding corrupt folder description from server for "+e),!1):this.markChildren(e,o,t.toBeSaved,t.missingChildren).then(function(){return!0}):this.local.setNodes(this.flush(t.toBeSaved)).then(function(){return!0})}.bind(this)):this.updateCommonTimestamp(e,n).then(function(){return!0})},handleResponse:function(e,t,o,i,n,r){var s=this.interpretStatus(o);if(s.successful){if("get"===t)return this.handleGetResponse(e,s,i,n,r);if("put"===t||"delete"===t)return this.completePush(e,t,s.conflict,r).then(function(){return!0});throw Error("cannot handle response for unknown action",t)}var a;return s.unAuth?a=new RemoteStorage.Unauthorized:s.networkProblems?(a=new RemoteStorage.SyncError("Network request failed."),this.remote.online=!1):a=Error("HTTP response code "+s.statusCode+" received."),this.dealWithFailure(e,t,s).then(function(){throw remoteStorage._emit("error",a),a})},numThreads:10,finishTask:function(e){return void 0===e.action?(delete this._running[e.path],void 0):(e.promise.then(function(t,o,i,n){return this.handleResponse(e.path,e.action,t,o,i,n)}.bind(this),function(t){return RemoteStorage.log("[Sync] wireclient rejects its promise!",e.path,e.action,t),this.handleResponse(e.path,e.action,"offline")}.bind(this)).then(function(t){if(delete this._timeStarted[e.path],delete this._running[e.path],this.remote.online=!0,t&&this._tasks[e.path]){for(i=0;this._tasks[e.path].length>i;i++)this._tasks[e.path][i]();delete this._tasks[e.path]}this._emit("req-done"),this.collectTasks(!1).then(function(){!this.hasTasks()||this.stopped?(RemoteStorage.log("[Sync] Sync is done! Reschedule?",Object.getOwnPropertyNames(this._tasks).length,this.stopped),this.done||(this.done=!0,this._emit("done"))):setTimeout(function(){this.doTasks()}.bind(this),10)}.bind(this))}.bind(this),function(t){console.error("[Sync] Error",t),delete this._timeStarted[e.path],delete this._running[e.path],this._emit("req-done"),this.done||(this.done=!0,this._emit("done"))}.bind(this)),void 0)},doTasks:function(){var e,t,o,i=0;if(e=this.remote.connected?this.remote.online?this.numThreads:1:0,t=e-Object.getOwnPropertyNames(this._running).length,0>=t)return!0;for(o in this._tasks)if(!this._running[o]&&(this._timeStarted=this.now(),this._running[o]=this.doTask(o),this._running[o].then(this.finishTask.bind(this)),i++,i>=t))return!0;return i>=t},collectTasks:function(e){return this.hasTasks()||this.stopped?(promise=promising(),promise.fulfill(),promise):this.collectDiffTasks().then(function(t){return t||e===!1?(promise=promising(),promise.fulfill(),promise):this.collectRefreshTasks()}.bind(this),function(e){throw e})},addTask:function(e,t){this._tasks[e]||(this._tasks[e]=[]),"function"==typeof t&&this._tasks[e].push(t)},sync:function(){return promising(),this.done=!1,this.doTasks()?promising().fulfill():this.collectTasks().then(function(){try{this.doTasks()}catch(e){console.error("[Sync] doTasks error",e)}}.bind(this),function(e){throw console.error("[Sync] Sync error",e),Error("Local cache unavailable")})}},RemoteStorage.prototype.getSyncInterval=function(){return s},RemoteStorage.prototype.setSyncInterval=function(e){if(!r(e))throw e+" is not a valid sync interval";var t=s;s=parseInt(e,10),this._emit("sync-interval-change",{oldValue:t,newValue:e})},RemoteStorage.prototype.getBackgroundSyncInterval=function(){return a},RemoteStorage.prototype.setBackgroundSyncInterval=function(e){if(!r(e))throw e+" is not a valid sync interval";var t=a;a=parseInt(e,10),this._emit("sync-interval-change",{oldValue:t,newValue:e})},RemoteStorage.prototype.getCurrentSyncInterval=function(){return c?a:s};var f=function(e){var t="Sync failed: ";t+="object"==typeof e&&"message"in e?e.message:e,this.originalError=e,this.message=t};f.prototype=Error(),f.prototype.constructor=f,RemoteStorage.SyncError=f,RemoteStorage.prototype.syncCycle=function(){this.sync.stopped||(this.sync.on("done",function(){RemoteStorage.log("[Sync] Sync done. Setting timer to",this.getCurrentSyncInterval()),this.sync.stopped||(this._syncTimer&&clearTimeout(this._syncTimer),this._syncTimer=setTimeout(this.sync.sync.bind(this.sync),this.getCurrentSyncInterval()))}.bind(this)),this.sync.sync())},RemoteStorage.prototype.stopSync=function(){this.sync?(RemoteStorage.log("[Sync] Stopping sync"),this.sync.stopped=!0):(RemoteStorage.log("[Sync] Will instantiate sync stopped"),this.syncStopped=!0)},RemoteStorage.prototype.startSync=function(){this.sync.stopped=!1,this.syncStopped=!1,this.sync.sync()};var p;RemoteStorage.Sync._rs_init=function(e){p=function(){RemoteStorage.log("[Sync] syncCycleCb calling syncCycle"),RemoteStorage.Env.isBrowser()&&n.bind(e)(),e.sync||(e.sync=new RemoteStorage.Sync(e.local,e.remote,e.access,e.caching),e.syncStopped&&(RemoteStorage.log("[Sync] Instantiating sync stopped"),e.sync.stopped=!0,delete e.syncStopped)),RemoteStorage.log("[Sync] syncCycleCb calling syncCycle"),e.syncCycle()},e.on("ready",p)},RemoteStorage.Sync._rs_cleanup=function(e){e.stopSync(),e.removeEventListener("ready",p)}}("undefined"!=typeof window?window:global),function(){function e(e){if("object"==typeof e&&"string"==typeof e.path)if(n(e.path)){if(e.local&&e.local.itemsMap)return e.local;if(e.common&&e.common.itemsMap)return e.common}else{if(e.local&&e.local.body&&e.local.contentType)return e.local;if(e.common&&e.common.body&&e.common.contentType)return e.common;if(e.body&&e.contentType)return{body:e.body,contentType:e.contentType}}}function t(t,o){var i;for(i in t){if(t[i]&&t[i].remote)return!0;if(nodeVersion=e(t[i]),nodeVersion&&nodeVersion.timestamp&&o>=(new Date).getTime()-nodeVersion.timestamp)return!1;if(!nodeVersion)return!0}return!0}function o(e){var t={path:e,common:{}};return n(e)&&(t.common.itemsMap={}),t}function i(e,t){return e.common||(e.common={itemsMap:{}}),e.common.itemsMap||(e.common.itemsMap={}),e.local||(e.local=s(e.common)),e.local.itemsMap||(e.local.itemsMap=e.common.itemsMap),e.local.itemsMap[t]=!0,e}var n=RemoteStorage.util.isFolder,r=RemoteStorage.util.isDocument,s=RemoteStorage.util.deepClone,a=RemoteStorage.util.equal,c=RemoteStorage.util.pathsFromRoot,l={get:function(o,i,r){var s=promising();return"number"==typeof i?this.getNodes(c(o)).then(function(n){var a=e(n[o]);t(n,i)?r(o,s):a?s.fulfill(200,a.body||a.itemsMap,a.contentType):s.fulfill(404)}.bind(this),function(e){s.reject(e)}):this.getNodes([o]).then(function(t){var i=e(t[o]);if(i){if(n(o))for(var r in i.itemsMap)i.itemsMap.hasOwnProperty(r)&&i.itemsMap[r]===!1&&delete i.itemsMap[r];s.fulfill(200,i.body||i.itemsMap,i.contentType)}else s.fulfill(404)}.bind(this),function(e){s.reject(e)}),s},put:function(t,n,r){var s=c(t);return this._updateNodes(s,function(t){try{for(var a=0;s.length>a;a++){var c,l=s[a],u=t[l];if(u||(t[l]=u=o(l)),0===a)c=e(u),u.local={body:n,contentType:r,previousBody:c?c.body:void 0,previousContentType:c?c.contentType:void 0};else{var d=s[a-1].substring(l.length);u=i(u,d)}}return t}catch(h){throw RemoteStorage.log("[Cachinglayer] Error during PUT",t,a,h),h}})},"delete":function(t){var o=c(t);return this._updateNodes(o,function(t){for(var i=0;o.length>i;i++){var n=o[i],r=t[n];if(!r)throw Error("Cannot delete non-existing node "+n);if(0===i)previous=e(r),r.local={body:!1,previousBody:previous?previous.body:void 0,previousContentType:previous?previous.contentType:void 0};else{r.local||(r.local=s(r.common));var a=o[i-1].substring(n.length);if(delete r.local.itemsMap[a],Object.getOwnPropertyNames(r.local.itemsMap).length>0)break}}return t})},flush:function(e){return this._getAllDescendentPaths(e).then(function(e){return this.getNodes(e)}.bind(this)).then(function(e){for(var t in e){var o=e[t];o&&o.common&&o.local&&this._emitChange({path:o.path,origin:"local",oldValue:o.local.body===!1?void 0:o.local.body,newValue:o.common.body===!1?void 0:o.common.body}),e[t]=void 0}return this.setNodes(e)}.bind(this))},_emitChange:function(e){RemoteStorage.config.changeEvents[e.origin]&&this._emit("change",e)},fireInitial:function(){RemoteStorage.config.changeEvents.local&&this.forAllNodes(function(t){var o;r(t.path)&&(o=e(t),o&&this._emitChange({path:t.path,origin:"local",oldValue:void 0,oldContentType:void 0,newValue:o.body,newContentType:o.contentType}))}.bind(this)).then(function(){this._emit("local-events-done")}.bind(this))},onDiff:function(e){this.diffHandler=e},migrate:function(e){return"object"!=typeof e||e.common||(e.common={},"string"==typeof e.path?"/"===e.path.substr(-1)&&"object"==typeof e.body&&(e.common.itemsMap=e.body):(e.local||(e.local={}),e.local.body=e.body,e.local.contentType=e.contentType)),e},_updateNodesRunning:!1,_updateNodesQueued:[],_updateNodes:function(e,t){var o=promising();return this._doUpdateNodes(e,t,o),o},_doUpdateNodes:function(e,t,o){var i=this;return this._updateNodesRunning?(this._updateNodesQueued.push({paths:e,cb:t,promise:o}),void 0):(this._updateNodesRunning=!0,this.getNodes(e).then(function(e){var n,c=s(e),l=[];e=t(e);for(var u in e)n=e[u],a(n,c[u])?delete e[u]:r(u)&&(l.push({path:u,origin:"window",oldValue:n.local.previousBody,newValue:n.local.body===!1?void 0:n.local.body,oldContentType:n.local.previousContentType,newContentType:n.local.contentType}),delete n.local.previousBody,delete n.local.previousContentType);i.setNodes(e).then(function(){i._emitChangeEvents(l),o.fulfill(200)})}).then(void 0,o.reject).then(function(){this._updateNodesRunning=!1;var e=this._updateNodesQueued.shift();e&&this._doUpdateNodes(e.paths,e.cb,e.promise)}.bind(this)),void 0)},_emitChangeEvents:function(e){for(var t=0;e.length>t;t++)this._emitChange(e[t]),this.diffHandler&&this.diffHandler(e[t].path)},_getAllDescendentPaths:function(t){return n(t)?this.getNodes([t]).then(function(o){var i=0,n=[t],r=e(o[t]),s=promising();for(var a in r.itemsMap)i++,this._getAllDescendentPaths(t+a).then(function(e){i--;for(var t=0;e.length>t;t++)n.push(e[t]);0===i&&s.fulfill(n)});return s}.bind(this)):promising().fulfill([t])},_getInternals:function(){return{getLatest:e,makeNode:o,isOutdated:t}}};RemoteStorage.cachingLayer=function(e){for(var t in l)e[t]=l[t]}}(),function(e){var t,o=RemoteStorage,i=2,n="remotestorage";o.IndexedDB=function(e){return this.db=e||t,this.db?(o.cachingLayer(this),o.eventHandling(this,"change","local-events-done"),this.getsRunning=0,this.putsRunning=0,this.changesQueued={},this.changesRunning={},void 0):(RemoteStorage.log("[IndexedDB] Failed to open DB"),void 0)},o.IndexedDB.prototype={getNodes:function(e){for(var t=[],o={},i=0;e.length>i;i++)void 0!==this.changesQueued[e[i]]?o[e[i]]=RemoteStorage.util.deepClone(this.changesQueued[e[i]]||void 0):void 0!==this.changesRunning[e[i]]?o[e[i]]=RemoteStorage.util.deepClone(this.changesRunning[e[i]]||void 0):t.push(e[i]);return t.length>0?this.getNodesFromDb(t).then(function(e){for(var t in o)e[t]=o[t];return e}):(promise=promising(),promise.fulfill(o),promise)},setNodes:function(e){var t=promising();for(var o in e)this.changesQueued[o]=e[o]||!1;return this.maybeFlush(),t.fulfill(),t},maybeFlush:function(){0===this.putsRunning?this.flushChangesQueued():this.commitSlownessWarning||(this.commitSlownessWarning=setInterval(function(){console.log("WARNING: waited more than 10 seconds for previous commit to finish")},1e4))},flushChangesQueued:function(){this.commitSlownessWarning&&(clearInterval(this.commitSlownessWarning),this.commitSlownessWarning=null),Object.keys(this.changesQueued).length>0&&(this.changesRunning=this.changesQueued,this.changesQueued={},this.setNodesInDb(this.changesRunning).then(this.flushChangesQueued.bind(this)))},getNodesFromDb:function(e){var t=promising(),o=this.db.transaction(["nodes"],"readonly"),i=o.objectStore("nodes"),n={};(new Date).getTime(),this.getsRunning++;for(var r=0;e.length>r;r++)(function(t){var o=e[t];i.get(o).onsuccess=function(e){n[o]=e.target.result}})(r);return o.oncomplete=function(){t.fulfill(n),this.getsRunning--}.bind(this),o.onerror=o.onabort=function(){t.reject("get transaction error/abort"),this.getsRunning--}.bind(this),t},setNodesInDb:function(e){var t=promising(),o=this.db.transaction(["nodes"],"readwrite"),i=o.objectStore("nodes"),n=(new Date).getTime();this.putsRunning++,RemoteStorage.log("[IndexedDB] Starting put",e,this.putsRunning);for(var r in e){var s=e[r];if("object"==typeof s)try{i.put(s)}catch(a){throw RemoteStorage.log("[IndexedDB] Error while putting",s,a),a}else try{i.delete(r)}catch(a){throw RemoteStorage.log("[IndexedDB] Error while removing",i,s,a),a}}return o.oncomplete=function(){t.fulfill(),this.putsRunning--,RemoteStorage.log("[IndexedDB] Finished put",e,this.putsRunning,(new Date).getTime()-n+"ms")}.bind(this),o.onerror=function(){t.reject("transaction error"),this.putsRunning--}.bind(this),o.onabort=function(){t.reject("transaction abort"),this.putsRunning--}.bind(this),t},reset:function(e){var t=this.db.name,i=this;this.db.close(),o.IndexedDB.clean(this.db.name,function(){o.IndexedDB.open(t,function(t,o){t?RemoteStorage.log("[IndexedDB] Error while resetting local storage",t):i.db=o,"function"==typeof e&&e(i)})})},forAllNodes:function(e){var t=promising(),o=this.db.transaction(["nodes"],"readonly"),i=o.objectStore("nodes").openCursor();return i.onsuccess=function(o){var i=o.target.result;i?(e(this.migrate(i.value)),i.continue()):t.fulfill()}.bind(this),t},closeDB:function(){this.db.close()}},o.IndexedDB.open=function(e,t){var o=setTimeout(function(){t("timeout trying to open db")},1e4),n=indexedDB.open(e,i);n.onerror=function(){RemoteStorage.log("[IndexedDB] Opening DB failed",n),clearTimeout(o),t(n.error)},n.onupgradeneeded=function(e){var t=n.result;RemoteStorage.log("[IndexedDB] Upgrade: from ",e.oldVersion," to ",e.newVersion),1!==e.oldVersion&&(RemoteStorage.log("[IndexedDB] Creating object store: nodes"),t.createObjectStore("nodes",{keyPath:"path"})),RemoteStorage.log("[IndexedDB] Creating object store: changes"),t.createObjectStore("changes",{keyPath:"path"})},n.onsuccess=function(){clearTimeout(o),t(null,n.result)}},o.IndexedDB.clean=function(e,t){var o=indexedDB.deleteDatabase(e);o.onsuccess=function(){RemoteStorage.log("[IndexedDB] Done removing DB"),t()},o.onerror=o.onabort=function(t){console.error('Failed to remove database "'+e+'"',t)}},o.IndexedDB._rs_init=function(e){var i=promising();return o.IndexedDB.open(n,function(o,n){o?i.reject(o):(t=n,n.onerror=function(){e._emit("error",o)},i.fulfill())}),i},o.IndexedDB._rs_supported=function(){var t=promising();if("indexedDB"in e)try{var o=indexedDB.open("rs-check");o.onerror=function(){t.reject()},o.onsuccess=function(){indexedDB.deleteDatabase("rs-check"),t.fulfill()}}catch(i){t.reject()}else t.reject();return t},o.IndexedDB._rs_cleanup=function(e){var t=promising();return e.local&&e.local.closeDB(),o.IndexedDB.clean(n,function(){t.fulfill()}),t}}("undefined"!=typeof window?window:global),function(e){function t(e){return e.substr(0,n.length)===n||e.substr(0,r.length)===r}function o(e){return e.substr(0,n.length)===n}var n="remotestorage:cache:nodes:",r="remotestorage:cache:changes:";RemoteStorage.LocalStorage=function(){RemoteStorage.cachingLayer(this),RemoteStorage.log("[LocalStorage] Registering events"),RemoteStorage.eventHandling(this,"change","local-events-done")},RemoteStorage.LocalStorage.prototype={getNodes:function(e){var t=promising(),o={};for(i=0;e.length>i;i++)try{o[e[i]]=JSON.parse(localStorage[n+e[i]])}catch(r){o[e[i]]=void 0}return t.fulfill(o),t},setNodes:function(e){var t=promising();for(var o in e)localStorage[n+o]=JSON.stringify(e[o]);return t.fulfill(),t},forAllNodes:function(e){for(var t,i=0;localStorage.length>i;i++)if(o(localStorage.key(i))){try{t=this.migrate(JSON.parse(localStorage[localStorage.key(i)]))}catch(n){t=void 0}t&&e(t)}return promising().fulfill()}},RemoteStorage.LocalStorage._rs_init=function(){},RemoteStorage.LocalStorage._rs_supported=function(){return"localStorage"in e},RemoteStorage.LocalStorage._rs_cleanup=function(){for(var e=[],o=0;localStorage.length>o;o++){var i=localStorage.key(o);t(i)&&e.push(i)}e.forEach(function(e){RemoteStorage.log("[LocalStorage] Removing",e),delete localStorage[e]})}}("undefined"!=typeof window?window:global),function(){RemoteStorage.InMemoryStorage=function(){RemoteStorage.cachingLayer(this),RemoteStorage.log("[InMemoryStorage] Registering events"),RemoteStorage.eventHandling(this,"change","local-events-done"),this._storage={}},RemoteStorage.InMemoryStorage.prototype={getNodes:function(e){var t=promising(),o={};for(i=0;e.length>i;i++)o[e[i]]=this._storage[e[i]];return t.fulfill(o),t},setNodes:function(e){var t=promising();for(var o in e)void 0===e[o]?delete this._storage[o]:this._storage[o]=e[o];return t.fulfill(),t},forAllNodes:function(e){for(var t in this._storage)e(this.migrate(this._storage[t]));return promising().fulfill()}},RemoteStorage.InMemoryStorage._rs_init=function(){},RemoteStorage.InMemoryStorage._rs_supported=function(){return!0},RemoteStorage.InMemoryStorage._rs_cleanup=function(){}}("undefined"!=typeof window?window:global),function(){RemoteStorage.MODULES={},RemoteStorage.defineModule=function(e,t){if(RemoteStorage.MODULES[e]=t,Object.defineProperty(RemoteStorage.prototype,e,{configurable:!0,get:function(){var t=this._loadModule(e);return Object.defineProperty(this,e,{value:t}),t}}),-1!==e.indexOf("-")){var o=e.replace(/\-[a-z]/g,function(e){return e[1].toUpperCase()});Object.defineProperty(RemoteStorage.prototype,o,{get:function(){return this[e]}})}},RemoteStorage.prototype._loadModule=function(e){var t=RemoteStorage.MODULES[e];if(t){var o=t(new RemoteStorage.BaseClient(this,"/"+e+"/"),new RemoteStorage.BaseClient(this,"/public/"+e+"/"));return o.exports}throw"Unknown module: "+e},RemoteStorage.prototype.defineModule=function(){console.log("remoteStorage.defineModule is deprecated, use RemoteStorage.defineModule instead!"),RemoteStorage.defineModule.apply(RemoteStorage,arguments)}}(),function(){function e(e,t,o){function i(e,t,o,i){[t,o,i].forEach(function(t){var o=document.createElement("td");o.textContent=t||"",e.appendChild(o)})}function n(e){function o(t,o,r,s){if(200===t){var c=document.createElement("tr");if(a.appendChild(c),i(c,e,r,s),"/"===e[e.length-1])for(var l in o)n(e+l)}}t.connected!==!1&&t.get(e).then(o)}e.setAttribute("border","1"),e.style.margin="8px",e.style.color="white",e.innerHTML="";var r=document.createElement("thead");e.appendChild(r);var s=document.createElement("tr");r.appendChild(s),["Path","Content-Type","Revision"].forEach(function(e){var t=document.createElement("th");t.textContent=e,r.appendChild(t)});var a=document.createElement("tbody");e.appendChild(a),o.forEach(n)}function t(t,o,i,n){var r=document.createElement("div"),s=document.createElement("h2");s.textContent=t,r.appendChild(s);var a=document.createElement("button");if(a.textContent="Refresh",a.onclick=function(){e(o,i,n)},r.appendChild(a),i.reset){var c=document.createElement("button");c.textContent="Reset",c.onclick=function(){i.reset(function(t){i=t,e(o,i,n)})},r.appendChild(c)}return r.appendChild(o),e(o,i,n),r}function o(e){function t(){r.innerHTML="",e.forAllNodes(function(e){if(e.local&&e.local.body){var t=document.createElement("li");t.textContent=JSON.stringify(e.local),r.appendChild(t)}})}var o=document.createElement("div"),i=document.createElement("h2");
i.textContent="Outgoing changes",o.appendChild(i);var n=document.createElement("button");n.textContent="Refresh",o.appendChild(n);var r=document.createElement("ul");return r.style.fontFamily="courier",o.appendChild(r),n.onclick=t,t(),o}RemoteStorage.prototype.inspect=function(){var i=document.createElement("div");i.id="remotestorage-inspect",i.style.position="absolute",i.style.top=0,i.style.left=0,i.style.background="black",i.style.color="white",i.style.border="groove 5px #ccc";var n=document.createElement("div");n.style.position="absolute",n.style.top=0,n.style.left=0;var r=document.createElement("strong");r.textContent=" remotestorage.js inspector ",n.appendChild(r);var s;this.local&&(s=document.createElement("button"),s.textContent="Synchronize",n.appendChild(s));var a=document.createElement("button");a.textContent="Close",a.onclick=function(){document.body.removeChild(i)},n.appendChild(a),i.appendChild(n);var c=[];for(var l in this.caching._rootPaths)this.caching._rootPaths.hasOwnProperty(l)&&c.push(l);var u=document.createElement("table"),d=document.createElement("table");i.appendChild(t("Remote",u,this.remote,c)),this.local&&(i.appendChild(t("Local",d,this.local,["/"])),i.appendChild(o(this.local)),s.onclick=function(){this.log("sync clicked"),this.sync.sync().then(function(){this.log("SYNC FINISHED"),e(d,this.local,["/"])}.bind(this),function(e){console.error("SYNC FAILED",e,e.stack)})}.bind(this)),document.body.appendChild(i)}}(),function(){function e(e){return"/"===e.substr(-1)&&(e=e.substr(0,e.length-1)),decodeURIComponent(e)}function t(e){return e.replace(/[^\/]+\/?$/,"")}function o(e){var t=e.split("/");return"/"===e.substr(-1)?t[t.length-2]+"/":t[t.length-1]}var i=RemoteStorage,n="https://www.googleapis.com",r="https://accounts.google.com/o/oauth2/auth",s="https://www.googleapis.com/auth/drive",a="application/vnd.google-apps.folder",c="application/json; charset=UTF-8",l=function(e){this.maxAge=e,this._items={}};l.prototype={get:function(e){var t=this._items[e],o=(new Date).getTime();return t&&t.t>=o-this.maxAge?t.v:void 0},set:function(e,t){this._items[e]={v:t,t:(new Date).getTime()}}},i.GoogleDrive=function(e,t){i.eventHandling(this,"change","connected","wire-busy","wire-done","not-connected"),this.rs=e,this.clientId=t,this._fileIdCache=new l(300)},i.GoogleDrive.prototype={connected:!1,online:!0,configure:function(e,t,o,i){i?(localStorage["remotestorage:googledrive:token"]=i,this.token=i,this.connected=!0,this._emit("connected")):(this.connected=!1,delete this.token,delete localStorage["remotestorage:googledrive:token"])},connect:function(){this.rs.setBackend("googledrive"),i.Authorize(r,s,i.Authorize.getLocation()+"",this.clientId)},stopWaitingForToken:function(){this.connected||this._emit("not-connected")},get:function(e,t){return"/"===e.substr(-1)?this._getFolder(e,t):this._getFile(e,t)},put:function(e,t,o,i){function n(e,t){if(e)r.reject(e);else if(t.status>=200&&300>t.status){var o=JSON.parse(t.responseText),i=o.etag.substring(1,o.etag.length-1);r.fulfill(200,void 0,o.mimeType,i)}else 412===t.status?r.fulfill(412,void 0,void 0,"conflict"):r.reject("PUT failed with status "+t.status+" ("+t.responseText+")")}var r=promising();return this._getFileId(e,function(s,a){if(s)return r.reject(s),void 0;if(a){if(i&&"*"===i.ifNoneMatch)return n(void 0,{status:412}),void 0;this._updateFile(a,e,t,o,i,n)}else this._createFile(e,t,o,i,n)}),r},"delete":function(e,t){var o=promising();return this._getFileId(e,function(e,i){return e?(o.reject(e),void 0):i?(this._getMeta(i,function(e,r){var s;return"object"==typeof r&&"string"==typeof r.etag&&(s=r.etag.substring(1,r.etag.length-1)),t&&t.ifMatch&&t.ifMatch!==s?(o.fulfill(412,void 0,void 0,s),void 0):e?(o.reject(e),void 0):(this._request("DELETE",n+"/drive/v2/files/"+i,{},function(e,t){e?o.reject(e):200===t.status||204===t.status?o.fulfill(200):o.reject("Delete failed: "+t.status+" ("+t.responseText+")")}),void 0)}),void 0):(o.fulfill(200),void 0)}),o},_updateFile:function(e,t,o,i,r,s){s=s.bind(this);var a={mimeType:i},c={"Content-Type":"application/json; charset=UTF-8"};r&&r.ifMatch&&(c["If-Match"]='"'+r.ifMatch+'"'),this._request("PUT",n+"/upload/drive/v2/files/"+e+"?uploadType=resumable",{body:JSON.stringify(a),headers:c},function(e,t){412===t.status?s(void 0,t):e?s(e):this._request("PUT",t.getResponseHeader("Location"),{body:i.match(/^application\/json/)?JSON.stringify(o):o},s)})},_createFile:function(t,i,r,s,a){a=a.bind(this),this._getParentId(t,function(s,c){if(s)return a(s),void 0;var l=o(t),u={title:e(l),mimeType:r,parents:[{kind:"drive#fileLink",id:c}]};this._request("POST",n+"/upload/drive/v2/files?uploadType=resumable",{body:JSON.stringify(u),headers:{"Content-Type":"application/json; charset=UTF-8"}},function(e,t){e?a(e):this._request("POST",t.getResponseHeader("Location"),{body:r.match(/^application\/json/)?JSON.stringify(i):i},a)})})},_getFile:function(e,t){var o=promising();return this._getFileId(e,function(e,i){e?o.reject(e):this._getMeta(i,function(e,i){var n;if("object"==typeof i&&"string"==typeof i.etag&&(n=i.etag.substring(1,i.etag.length-1)),e)o.reject(e);else{if(t&&t.ifNoneMatch&&n==t.ifNoneMatch)return o.fulfill(304),void 0;var r={};if(!i.downloadUrl){if(!i.exportLinks||!i.exportLinks["text/html"])return o.fulfill(200,"",i.mimeType,n),void 0;i.mimeType+=";export=text/html",i.downloadUrl=i.exportLinks["text/html"]}i.mimeType.match(/charset=binary/)&&(r.responseType="blob"),this._request("GET",i.downloadUrl,r,function(e,t){if(e)o.reject(e);else{var r=t.response;if(i.mimeType.match(/^application\/json/))try{r=JSON.parse(r)}catch(s){}o.fulfill(200,r,i.mimeType,n)}})}})}),o},_getFolder:function(e){var t=promising();return this._getFileId(e,function(o,i){var r,s,l,u,d,h;o?t.reject(o):i?(r="'"+i+"' in parents",s="items(downloadUrl,etag,fileSize,id,mimeType,title)",this._request("GET",n+"/drive/v2/files?"+"q="+encodeURIComponent(r)+"&fields="+encodeURIComponent(s)+"&maxResults=1000",{},function(o,i){if(o)t.reject(o);else if(200===i.status){try{l=JSON.parse(i.responseText)}catch(n){return t.reject("non-JSON response from GoogleDrive"),void 0}for(h={},u=0;l.items.length>u;u++)d=l.items[u].etag.substring(1,l.items[u].etag.length-1),l.items[u].mimeType===a?(this._fileIdCache.set(e+l.items[u].title+"/",l.items[u].id),h[l.items[u].title+"/"]={ETag:d}):(this._fileIdCache.set(e+l.items[u].title,l.items[u].id),h[l.items[u].title]={ETag:d,"Content-Type":l.items[u].mimeType,"Content-Length":l.items[u].fileSize});t.fulfill(200,h,c,void 0)}else t.reject("request failed or something: "+i.status)})):t.fulfill(404)}),t},_getParentId:function(e,o){o=o.bind(this);var i=t(e);this._getFileId(i,function(e,t){e?o(e):t?o(null,t):this._createFolder(i,o)})},_createFolder:function(t,i){i=i.bind(this),this._getParentId(t,function(r,s){r?i(r):this._request("POST",n+"/drive/v2/files",{body:JSON.stringify({title:e(o(t)),mimeType:a,parents:[{id:s}]}),headers:{"Content-Type":"application/json; charset=UTF-8"}},function(e,t){if(e)i(e);else{var o=JSON.parse(t.responseText);i(null,o.id)}})})},_getFileId:function(e,o){o=o.bind(this);var i;"/"===e?o(null,"root"):(i=this._fileIdCache.get(e))?o(null,i):this._getFolder(t(e)).then(function(){var t=this._fileIdCache.get(e);return t?(o(null,t),void 0):("/"===e.substr(-1)?this._createFolder(e,function(){this._getFileId(e,o)}.bind(this)):o(null,null),void 0)}.bind(this),o)},_getMeta:function(e,t){t=t.bind(this),this._request("GET",n+"/drive/v2/files/"+e,{},function(o,i){o?t(o):200===i.status?t(null,JSON.parse(i.responseText)):t("request (getting metadata for "+e+") failed with status: "+i.status)})},_request:function(e,t,o,n){n=n.bind(this),o.headers||(o.headers={}),o.headers.Authorization="Bearer "+this.token,i.WireClient.request.call(this,e,t,o,function(e,t){return t&&401===t.status?(this.connect(),void 0):(n(e,t),void 0)})}},i.GoogleDrive._rs_init=function(e){var t=e.apiKeys.googledrive;t&&(e.googledrive=new i.GoogleDrive(e,t.client_id),"googledrive"===e.backend&&(e._origRemote=e.remote,e.remote=e.googledrive))},i.GoogleDrive._rs_supported=function(){return!0},i.GoogleDrive._rs_cleanup=function(e){e.setBackend(void 0),e._origRemote&&(e.remote=e._origRemote,delete e._origRemote)}}(this),function(e){function t(e){this.defaultValue=e,this._storage={},this.set=this.justSet,this.delete=this.justDelete}function o(e){e._dropboxOrigSync||(e._dropboxOrigSync=e.sync.bind(e),e.sync=function(){return this.dropbox.fetchDelta.apply(this.dropbox,arguments).then(e._dropboxOrigSync,function(t){e._emit("error",new e.SyncError(t))})})}function i(e){e._dropboxOrigSync&&(e.sync=e._dropboxOrigSync,delete e._dropboxOrigSync)}function n(e){e._origBaseClientGetItemURL||(e._origBaseClientGetItemURL=d.BaseClient.prototype.getItemURL,d.BaseClient.prototype.getItemURL=function(t){var o=e.dropbox._itemRefs[t];return o?o:""})}function r(e){e._origBaseClieNtGetItemURL&&(d.BaseClient.prototype.getItemURL=e._origBaseClietGetItemURL,delete e._origBaseClietGetItemURL)}function s(e){e._origRemote||(e._origRemote=e.remote,e.remote=e.dropbox)}function a(e){e._origRemote&&(e.remote=e._origRemote,delete e._origRemote)}function c(e){s(e),e.sync&&o(e),n(e)}function l(e){a(e),i(e),r(e)}var u,d=RemoteStorage,h="https://www.dropbox.com/1/oauth2/authorize",g="remotestorage:dropbox",m=d.WireClient.cleanPath;t.prototype={get:function(e){e=e.toLowerCase();var t=this._storage[e];return t===void 0&&(t=this.defaultValue,this._storage[e]=t),t},propagateSet:function(e,t){return e=e.toLowerCase(),this._storage[e]===t?t:(this._propagate(e,t),this._storage[e]=t)},propagateDelete:function(e){return e=e.toLowerCase(),this._propagate(e,this._storage[e]),delete this._storage[e]},_activatePropagation:function(){return this.set=this.propagateSet,this.delete=this.propagateDelete,!0},justSet:function(e,t){return e=e.toLowerCase(),this._storage[e]=t},justDelete:function(e){return e=e.toLowerCase(),delete this._storage[e]},_propagate:function(e,t){for(var o=e.split("/").slice(0,-1),i=o.length,n="",r=0;i>r;r++)n+=o[r]+"/",t||(t=this._storage[n]+1),this._storage[n]=t}};var f;d.Dropbox=function(e){this.rs=e,this.connected=!1,this.rs=e;var o=this;if(f=function(e){e instanceof RemoteStorage.Unauthorized&&o.configure(null,null,null,null)},d.eventHandling(this,"change","connected","wire-busy","wire-done","not-connected"),e.on("error",f),this.clientId=e.apiKeys.dropbox.api_key,this._revCache=new t("rev"),this._itemRefs={},this._metadataCache={},u){var i;try{i=JSON.parse(localStorage[g])}catch(n){}i&&this.configure(i.userAddress,void 0,void 0,i.token);try{this._itemRefs=JSON.parse(localStorage[g+":shares"])}catch(n){}}this.connected&&setTimeout(this._emit.bind(this),0,"connected")},d.Dropbox.prototype={online:!0,connect:function(){this.rs.setBackend("dropbox"),this.token?c(this.rs):d.Authorize(h,"",d.Authorize.getLocation()+"",this.clientId)},configure:function(e,t,o,i){i!==void 0&&(this.token=i),e!==void 0&&(this.userAddress=e),this.token?(this.connected=!0,this.userAddress||this.info().then(function(e){this.userAddress=e.display_name}.bind(this)),this._emit("connected")):this.connected=!1,u&&(localStorage[g]=JSON.stringify({token:this.token,userAddress:this.userAddress}))},stopWaitingForToken:function(){this.connected||this._emit("not-connected")},_getFolder:function(e){var t="https://api.dropbox.com/1/metadata/auto"+e,o=promising(),i=this._revCache;return this._request("GET",t,{},function(t,n){if(t)o.reject(t);else{var r=n.status;if(304===r)return o.fulfill(r),void 0;var s,a,c,l;try{a=JSON.parse(n.responseText)}catch(u){return o.reject(u),void 0}l=this._revCache.get(e),c="application/json; charset=UTF-8",a.contents&&(s=a.contents.reduce(function(t,o){var n=o.path.split("/").slice(-1)[0]+(o.is_dir?"/":"");return t[n]=o.is_dir?{ETag:i.get(e+n)}:{ETag:o.rev},t},{})),o.fulfill(r,s,c,l)}}),o},get:function(e,t){if(!this.connected)throw Error("not connected (path: "+e+")");e=m(e);var o="https://api-content.dropbox.com/1/files/auto"+e,i=this._sharePromise(e),n=this._revCache.get(e);return null===n?(i.fulfill(404),i):t&&t.ifNoneMatch&&n&&n===t.ifNoneMatch?(i.fulfill(304),i):"/"===e.substr(-1)?this._getFolder(e,t):(this._request("GET",o,{},function(t,o){if(t)i.reject(t);else{var n,r,s,a,c=o.status;if(200===c){r=o.responseText;try{n=JSON.parse(o.getResponseHeader("x-dropbox-metadata"))}catch(l){return i.reject(l),void 0}if(s=n.mime_type,a=n.rev,this._revCache.set(e,a),!o.getResponseHeader("Content-Type")||o.getResponseHeader("Content-Type").match(/charset=binary/))d.WireClient.readBinaryData(o.response,s,function(e){i.fulfill(c,e,s,a)});else{try{r=JSON.parse(r),s="application/json; charset=UTF-8"}catch(l){}i.fulfill(c,r,s,a)}}else i.fulfill(c)}}),i)},put:function(e,t,o,i){if(!this.connected)throw Error("not connected (path: "+e+")");var n=e;e=m(e);var r=this,s=this._sharePromise(e),a=this._revCache,c=a.get(e);if(i&&i.ifMatch&&c&&c!==i.ifMatch)return s.fulfill(412,void 0,void 0,c),s;if(i&&"*"===i.ifNoneMatch&&c&&"rev"!==c)return s.fulfill(412,void 0,void 0,c),s;!o.match(/charset=/)&&(t instanceof ArrayBuffer||d.WireClient.isArrayBufferView(t))&&(o+="; charset=binary");var l="https://api-content.dropbox.com/1/files_put/auto"+e+"?";if(i&&i.ifMatch&&(l+="parent_rev="+encodeURIComponent(i.ifMatch)),t.length>157286400)RemoteStorage.log("files larger than 150MB not supported yet");else{var u=promising();i&&(i.ifMatch||"*"===i.ifNoneMatch)?this._getMetadata(n).then(function(e){u.fulfill(e)}):u.fulfill(),u.then(function(c){return i&&"*"===i.ifNoneMatch&&c?(s.fulfill(412,void 0,void 0,c.rev),void 0):i&&i.ifMatch&&c&&c.rev!==i.ifMatch?(s.fulfill(412,void 0,void 0,c.rev),void 0):(r._request("PUT",l,{body:t,headers:{"Content-Type":o}},function(t,o){if(t)s.reject(t);else if(200===o.status){var i=JSON.parse(o.responseText);if(i.path===n)a.propagateSet(e,i.rev),s.fulfill(o.status);else{var c="https://api.dropbox.com/1/fileops/delete?root=auto&path="+encodeURIComponent(i.path);r._request("POST",c,{},function(){}),r._getMetadata(e).then(function(e){s.fulfill(412,void 0,void 0,e.rev)})}}else s.fulfill(o.status)}),void 0)})}return s},"delete":function(e,t){if(!this.connected)throw Error("not connected (path: "+e+")");var o=e;e=m(e);var i=this,n=promising(),r=this._revCache,s=r.get(e);if(t&&t.ifMatch&&s&&t.ifMatch!==s)return n.fulfill(412,void 0,void 0,s),n;var a=promising();return t&&t.ifMatch?this._getMetadata(o).then(function(e){a.fulfill(e)}):a.fulfill(),a.then(function(s){if(t&&t.ifMatch&&s&&s.rev!==t.ifMatch)return n.fulfill(412,void 0,void 0,s.rev),void 0;var a="https://api.dropbox.com/1/fileops/delete?root=auto&path="+encodeURIComponent(o);i._request("POST",a,{},function(t,o){t?n.reject(error):(200===o.status&&r.delete(e),n.fulfill(o.status))})}),n.then(function(){var t=Array.prototype.slice.call(arguments);delete this._itemRefs[e];var o=promising();return o.fulfill.apply(o,t)}.bind(this))},_sharePromise:function(e){var t=promising(),o=this;return e.match(/^\/public\/.*[^\/]$/)&&this._itemRefs[e]===void 0&&t.then(function(){var t=Array.prototype.slice.call(arguments),i=promising();return o.share(e).then(function(){i.fulfill.apply(i,t)},function(){i.fulfill.apply(i,t)}),i}),t},share:function(e){var t="https://api.dropbox.com/1/media/auto"+e,o=promising(),i=this._itemRefs;return this._request("POST",t,{},function(t,n){if(t)RemoteStorage.log(t),t.message='Shareing Dropbox Thingie("'+e+'") failed'+t.message,o.reject(t);else try{var r=JSON.parse(n.responseText),s=r.url;i[e]=s,u&&(localStorage[g+":shares"]=JSON.stringify(this._itemRefs)),o.fulfill(s)}catch(t){t.message+="share error",o.reject(t)}}),o},info:function(){var e="https://api.dropbox.com/1/account/info",t=promising();return this._request("GET",e,{},function(e,o){if(e)t.reject(e);else try{var i=JSON.parse(o.responseText);t.fulfill(i)}catch(n){t.reject(e)}}),t},_request:function(t,o,i,n){n=n.bind(this),i.headers||(i.headers={}),i.headers.Authorization="Bearer "+this.token,d.WireClient.request.call(this,t,o,i,function(r,s){s&&503===s.status?e.setTimeout(this._request(t,o,i,n),3210):n(r,s)})},fetchDelta:function(){var e=Array.prototype.slice.call(arguments),o=promising(),i=this;return this._request("POST","https://api.dropbox.com/1/delta",{body:this._deltaCursor?"cursor="+encodeURIComponent(this._deltaCursor):"",headers:{"Content-Type":"application/x-www-form-urlencoded"}},function(n,r){if(n)this.rs.log("fetchDeltas",n),this.rs._emit("error",new RemoteStorage.SyncError("fetchDeltas failed"+n)),o.reject(n);else{if(200!==r.status)return 400===r.status?(this.rs._emit("error",new RemoteStorage.Unauthorized),o.fulfill.apply(o,e)):o.reject("dropbox.fetchDelta returned "+r.status+r.responseText),o;var s;try{s=JSON.parse(r.responseText)}catch(n){return d.log("fetchDeltas can not parse response",n),o.reject("can not parse response of fetchDelta : "+n.message)}if(!s.entries)return o.reject("dropbox.fetchDeltas failed, no entries found");s.reset&&(this._revCache=new t("rev"),o.then(function(){var e=Array.prototype.slice.call(arguments);i._revCache._activatePropagation();var t=promising();return t.fulfill.apply(t,e)})),s.cursor&&(this._deltaCursor=s.cursor),RemoteStorage.log("Delta : ",s.entries),s.entries.forEach(function(e){var t,o=e[0];if(e[1]){if(e[1].is_dir)return;t=e[1].rev}else t=null;i._revCache.set(o,t)}),o.fulfill.apply(o,e)}}),o},_getMetadata:function(e,t){var o=promising(),i=this,n=this._metadataCache[e],r="https://api.dropbox.com/1/metadata/auto"+m(e);return r+="?list="+(t&&t.list?"true":"false"),n&&n.hash&&(r+="&hash="+encodeURIComponent(n.hash)),this._request("GET",r,{},function(t,r){if(t)return o.reject(t),void 0;if(304===r.status)o.fulfill(n);else if(200===r.status){var s=JSON.parse(r.responseText);i._metadataCache[e]=s,o.fulfill(s)}else o.fulfill()}),o}},d.Dropbox._rs_init=function(e){u=e.localStorageAvailable(),e.apiKeys.dropbox&&(e.dropbox=new d.Dropbox(e)),"dropbox"===e.backend&&c(e)},d.Dropbox._rs_supported=function(){return!0},d.Dropbox._rs_cleanup=function(e){l(e),u&&delete localStorage[g],e.removeEventListener("error",f),e.setBackend(void 0)}}(this),remoteStorage=new RemoteStorage;