/*! built for Dogfeed 2014-09-10 */
!function(a,b){"function"==typeof define&&define.amd?define(b):a.SockethubClient=b()}(this,function(){var a,b,c;return function(d){function e(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=p.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0)&&b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function f(a,b){return function(){return m.apply(d,r.call(arguments,0).concat([a,b]))}}function g(a){return function(b){return e(b,a)}}function h(a){return function(b){n[a]=b}}function i(a){if(o.hasOwnProperty(a)){var b=o[a];delete o[a],q[a]=!0,l.apply(d,b)}if(!n.hasOwnProperty(a))throw new Error("No "+a);return n[a]}function j(a,b){var c,d,f=a.indexOf("!");return-1!==f?(c=e(a.slice(0,f),b),a=a.slice(f+1),d=i(c),a=d&&d.normalize?d.normalize(a,g(b)):e(a,b)):a=e(a,b),{f:c?c+"!"+a:a,n:a,p:d}}function k(a){return function(){return p&&p.config&&p.config[a]||{}}}var l,m,n={},o={},p={},q={},r=[].slice;l=function(a,b,c,e){var g,l,m,p,r,s,t=[];if(e=e||a,"function"==typeof c){for(b=!b.length&&c.length?["require","exports","module"]:b,r=0;r<b.length;r+=1)if(p=j(b[r],e),l=p.f,"require"===l)t[r]=f(a);else if("exports"===l)t[r]=n[a]={},s=!0;else if("module"===l)g=t[r]={id:a,uri:"",exports:n[a],config:k(a)};else if(n.hasOwnProperty(l)||o.hasOwnProperty(l))t[r]=i(l);else if(p.p)p.p.load(p.n,f(e,!0),h(l),{}),t[r]=n[l];else if(!q[l])throw new Error(a+" missing "+l);m=c.apply(n[a],t),a&&(g&&g.exports!==d&&g.exports!==n[a]?n[a]=g.exports:m===d&&s||(n[a]=m))}else a&&(n[a]=c)},a=b=m=function(a,b,c,e,f){return"string"==typeof a?i(j(a,b).f):(a.splice||(p=a,b.splice?(a=b,b=c,c=null):a=d),b=b||function(){},"function"==typeof c&&(c=e,e=f),e?l(d,a,b,c):setTimeout(function(){l(d,a,b,c)},15),m)},m.config=function(a){return p=a,m},c=function(a,b,c){b.splice||(c=b,b=[]),o[a]=[a,b,c]},c.amd={jQuery:!0}}(),c("vendor/almond",function(){}),c("sockethub/extend",[],function(){function a(b){var c=Array.prototype.slice.call(arguments,1);return c.forEach(function(c){for(var d in c)"object"==typeof c[d]&&"object"==typeof b[d]?a(b[d],c[d]):b[d]=c[d]}),b}return a}),function(){function a(b){function c(a){if(f){var b;if(a.fulfilled)try{b=[a.fulfilled.apply(null,g)]}catch(c){return void a.promise.reject(c)}else b=g;b[0]&&"function"==typeof b[0].then?b[0].then(a.promise.fulfill,a.promise.reject):a.promise.fulfill.apply(null,b)}else if(a.rejected){var d;try{d=a.rejected.apply(null,g)}catch(c){return void a.promise.reject(c)}d&&"function"==typeof d.then?d.then(a.promise.fulfill,a.promise.reject):a.promise.fulfill(d)}else a.promise.reject.apply(null,g)}function d(a,b){return g?void console.log("WARNING: Can't resolve promise, already resolved!"):(f=a,g=Array.prototype.slice.call(b),void setTimeout(function(){for(var a=h.length,b=0;a>b;b++)c(h[b]);h=void 0},0))}var e;"function"==typeof b&&setTimeout(function(){try{b(e)}catch(a){e.reject(a)}},0);var f,g,h=[];return e={then:function(b,d){var e={fulfilled:"function"==typeof b?b:void 0,rejected:"function"==typeof d?d:void 0,promise:a()};return g?setTimeout(function(){c(e)},0):h.push(e),e.promise},fulfill:function(){return d(!0,arguments),this},reject:function(){return d(!1,arguments),this}}}"undefined"!=typeof module?module.exports=a:"function"==typeof c?c("vendor/promising",[],function(){return a}):"undefined"!=typeof window&&(window.promising=a)}(),c("sockethub/event_handling",[],function(){var a={on:function(a,b){this._validateEvent(a),this._handlers[a].push(b)},_emit:function(a){this._validateEvent(a);var b=Array.prototype.slice.call(arguments,1);this._handlers[a].forEach(function(a){a.apply(this,b)})},_validateEvent:function(a){if(!(a in this._handlers))throw"Unknown event: "+a},_delegateEvent:function(a,b){b.on(a,function(b){this._emit(a,b)}.bind(this))},_addEvent:function(a){this._handlers[a]=[]}};return function(b){var c=Array.prototype.slice.call(arguments,1);for(var d in a)b[d]=a[d];b._handlers={},c.forEach(function(a){b._addEvent(a)})}}),c("sockethub/client",["./extend","../vendor/promising","./event_handling"],function(a,b,c){var d=function(a,b){this.jsonClient=a,this.options=b,this._ridPromises={},c(this,"connected","disconnected","failed","message","unexpected-response","reconnecting","reconnected"),a.on("message",this._processIncoming.bind(this)),this._delegateEvent("connected",a),this._delegateEvent("disconnected",a),this._delegateEvent("failed",a),this._delegateEvent("reconnecting",a),this._delegateEvent("reconnected",a),this.__defineGetter__("connected",function(){return this.jsonClient.connected})};return d.prototype={declareVerb:function(b,c,d,e){this[b]=function(){var e=Array.prototype.slice.call(arguments),f=a({},d,{verb:b});c.forEach(function(a,b){var c=e[b],d=this._getDeepAttr(f,a);if("undefined"==typeof d&&"undefined"==typeof c)throw new Error("Expected a value for parameter "+a+", but got undefined!");this._setDeepAttr(f,a,c)}.bind(this));var g=e[c.length];return"object"==typeof g&&a(f,g),this.sendObject(f)},e&&(this[b]=e(this[b].bind(this)))},declareEvent:function(a){this._addEvent(a)},disconnect:function(){this.jsonClient.disconnect()},_ridCounter:0,sendObject:function(c){var d=b(),e=++this._ridCounter;return this._ridPromises[e]=d,c=a(c,{rid:e}),this.jsonClient.send(c),d},_getDeepAttr:function(a,b,c){var d=c||b.split("."),e=a[d.shift()];return d.length?this._getDeepAttr(e,void 0,d):e},_setDeepAttr:function(a,b,c,d){var e=d||b.split(".");e.length>1?this._setDeepAttr(a[e.shift()],void 0,c,e):a[e[0]]=c},_processIncoming:function(a){console.log("confirm"===a.verb?"CONFIRM":"RECEIVE",a);var b=a.rid;if("undefined"!=typeof b){var c=this._ridPromises[b];if(c){if("confirm"===a.verb){if(a.status)return;c.reject(a)}else"status"in a?c[a.status?"fulfill":"reject"](a):c.fulfill(a);delete this._ridPromises[b]}else this._emit("unexpected-response",a)}else this._emit("message",a)}},d}),c("sockethub/json_client",["./event_handling"],function(a){var b=function(b,c,d){this.uri=b,this.protocol=c,this.reconnect=d||!1,a(this,"message","connected","reconnecting","reconnected","disconnected","failed"),this.wsConnect()};return b.prototype={wsConnect:function(){this.socket=null,delete this.socket;var a=new WebSocket(this.uri,this.protocol);this.socket=a,this._listen()},send:function(a){this.socket.send(JSON.stringify(a))},disconnect:function(){this.socket.close()},_listen:function(){this.socket.onmessage=this._processMessageEvent.bind(this),this.connected=!1;var a=this;this.socket.onopen=function(){this.connected=!0,this.reconnecting?(this._emit("reconnected"),this.reconnecting=!1):this._emit("connected")}.bind(this),this.socket.onclose=function(){this.connected&&!this.reconnect?(console.log("sockethub-client disconnected, not reconnecting..."),this._emit("disconnected"),this.connected=!1):this.connected&&this.reconnect?(this._emit("reconnecting"),this.connected=!1,this.reconnecting=!0,console.log("sockethub-client disconnected, attempting reconnect..."),this.wsConnect()):this.reconnecting&&!this.connected?setTimeout(function(){console.log("sockethub-client attempting reconnect after 5s"),a.wsConnect()},5e3):this._emit("failed")}.bind(this)},_processMessageEvent:function(a){this._emit("message",JSON.parse(a.data))}},b}),c("sockethub/connect",["./extend","./json_client","./client"],function(a,b,c){var d=10550,e="/sockethub",f="sockethub",g=function(g,h){var i;if("object"!=typeof h&&(h={reconnect:!0}),"string"!=typeof g||g.match(/wss?\:\/\//)||(g={host:g}),"string"==typeof g)i=g;else{if("object"!=typeof g)throw"SockethubClient.connect expects a URI, specified via a String or Object.";if(a(h,g),!h.host)throw"Required 'host' option not present";h.port||(h.port=d),h.path||(h.path=e),h.reconnect="boolean"==typeof h.reconnect?h.reconnect:!0,i=(h.ssl?"wss":"ws")+"://"+h.host+":"+h.port+h.path}return new c(new b(i,f,h.reconnect),h)};return g}),c("sockethub/remoteStorage",[],function(){function a(a){a.defineModule("sockethub",b),a.access.claim("sockethub","rw");var c=a.getBearerToken();if("string"==typeof c&&c.length>0){this.options.register||(this.options.register={});var d={};a.access.scopes.forEach(function(b){d[b]=a.access.get(b)});var e=a.getStorageInfo();e.type=String(e.type),this.options.register.remoteStorage={storageInfo:e,bearerToken:c,scope:d}}}var b=function(a){return a.declareType("config",{description:"sockethub config file",type:"object",properties:{host:{type:"string",description:"the hostname to connect to",format:"uri",required:!0},port:{type:"number",description:"the port number to connect to",required:!0},secret:{type:"string",description:"the secret to identify yourself with the sockethub server",required:!0}}}),{exports:{getConfig:function(){return a.getObject("config.json")},writeConfig:function(b){return a.storeObject("config","config.json",b)}}}};return a}),c("verbs/core",[],function(){var a=function(a){function b(){console.log("options passed to connect:",a.options),a.options.register&&(console.log("automatic registration!"),a.register(a.options.register))}a.declareVerb("ping",[],{platform:"dispatcher"},function(a){return function(b){return"object"!=typeof b&&(b={}),"number"!=typeof b.timestamp&&(b.timestamp=(new Date).getTime()),a(b).then(function(a){return a.offset=(new Date).getTime()-b.timestamp,a})}}),a.declareVerb("register",["object"],{platform:"dispatcher"},function(b){return function(){return a.registered&&(console.log("WARNING: already registered!"),console.trace()),b.apply(this,arguments).then(function(b){if(a.registered=b.status,!b.status)throw setTimeout(function(){a._emit("registration-failed",b)},0),"registration failed: "+b.message;return setTimeout(function(){a._emit("registered")},0),b})}}),a.registered=!1,a.declareEvent("registered"),a.declareEvent("registration-failed"),a.on("connected",b),a.on("reconnected",b),a.on("disconnected",function(){delete a.registered}),a.declareVerb("set",["target.platform","object"],{platform:"dispatcher",target:{}})};return a}),c("sockethub-client",["sockethub/client","sockethub/connect","sockethub/remoteStorage","verbs/core"],function(a,b,c,d){return a.connect=function(){var a=b.apply(this,arguments);return d(a),a},a.prototype.connectStorage=c,a}),b("sockethub-client")});